I"˜<h1 id="å‰è¨€">å‰è¨€</h1>

<p>è¿‘æœŸé’ˆå¯¹å‰æ–¹å®¢æˆ·æå‡ºçš„å…·ä½“S3æµ‹è¯•è¦æ±‚ï¼Œæµ‹è¯•äº†ä¸€ä¸‹S3æ€§èƒ½ï¼Œä½¿ç”¨çš„æ˜¯cosbenchå·¥å…·ã€‚åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæ’é™¤å®¢æˆ·çš„è¦æ±‚å¤–ï¼Œæˆ‘ä»¬è‡ªèº«ä¹Ÿæƒ³çŸ¥é“ï¼Œå½“å‰ç¡¬ä»¶æ¡ä»¶ä¸‹ï¼Œæ¯é—´éš”1,000,00,00ä¸ªobjectï¼ŒIOPSå’Œè€—æ—¶æ˜¯å¤šä¹…ï¼Œæ¯”å¦‚ï¼š1åˆ°1åƒä¸‡ï¼Œ1åƒä¸‡åˆ°2åƒä¸‡ï¼Œã€‚ã€‚ã€‚1äº¿åˆ°1.1äº¿ä¸ªobject, and so onã€‚
ç”±äºæµ‹è¯•åœºæ™¯æ¯”è¾ƒå¤šï¼Œè€Œä¸”æµ‹è¯•æ—¶é•¿ä¹Ÿä¼šå¾ˆä¹…ï¼Œæ‰€æœ‰å†™äº†è¿™ä¸ªè„šæœ¬ï¼Œç»Ÿè®¡ä¸€ä¸‹ä¸åŒlevel objectæ•°æ®ä¸‹çš„IOPSå’Œè€—æ—¶ï¼ˆå½“ç„¶ï¼Œcosbenchçš„ä»»åŠ¡æ˜¯æ¯é—´éš”1åƒä¸‡æäº¤ä¸€æ¬¡ï¼Œå³ä¸€ä¸ªxmlé‡Œå†™1åƒä¸‡ä¸ªobjectï¼Œç›´åˆ°æ•°æ®é‡è¿‡äº¿,æ‰€ä»¥cosbenchæäº¤çš„æ˜¯å¤šä¸ªä»»åŠ¡æ¥å®Œæˆæ•°æ®è¿‡äº¿çš„æµ‹è¯•ï¼‰ã€‚</p>

<h1 id="è„šæœ¬å†…å®¹">è„šæœ¬å†…å®¹</h1>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@fireware:~# cat calc_cosbench_task_time.py 
#!/usr/bin/env python
# -*- coding:UTF-8 -*-

import os
import sys
from datetime import datetime

from ezs3.command import do_cmd


def get_start_end_time():
    all_work_dict = {}

    all_csv_file = do_cmd("find {} -iname *WRITEJOB.csv -print".format(archive_home), 30).strip()
    for each_csv in all_csv_file.split('\n'):
        work_id = each_csv.split('/')[-2].split('-')[0]
        start_time = do_cmd("cat '{}' | awk -F ',' '{{print $1}}' | grep -v 'Timestamp' |  sed '/^$/d' | head -n 1".format(each_csv), 30).strip()
        end_time = do_cmd("tac '{}' | awk -F ',' '{{print $1}}' | grep -v 'Timestamp' | head -n 1".format(each_csv), 30).strip() 
        all_work_dict[work_id] = [start_time, end_time]

    sorted(all_work_dict.items(), lambda x, y: cmp(x[0], y[0]))
    return all_work_dict


# def calc_elapsed_time(all_work_dict):
#     elapsed_time_dict = {}
# 
#     for each_key in all_work_dict.items():
#         start_at = each_key[1][0]
#         stop_at = each_key[1][1]
# 
#         if start_at and stop_at:
#             start = datetime.strptime(start_at, '%H:%M:%S')
#             end = datetime.strptime(stop_at, '%H:%M:%S')
#             elapsed_time = (end-start).seconds
# 
#             elapsed_time_dict[each_key[0]] = elapsed_time
#         else:
#             elapsed_time_dict[each_key[0]] = 0
# 
#     sorted(elapsed_time_dict.items(), lambda x, y: cmp(x[0], y[0]))
#     return elapsed_time_dict
# 
# 
# def calc_ops():
#     ops_dict = {}
#     all_csv_file = do_cmd("find {} -iname *W.csv -print".format(archive_home), 30).strip()
# 
#     for each_csv in all_csv_file.split('\n'):
#         cur_work_op_list = []
#         work_id = each_csv.split('/')[-2].split('-')[0]
#         ops_info = do_cmd("cat '{}' | awk '{{print $1}}' | awk -F ',' '{{print $14}}' | grep -v Throughput".format(each_csv), 30).strip() 
#         ops_dict[work_id] = sum(map(float, ops_info.split("\n")))
# 
#     return ops_dict


def calc_elapsed_time_ops(all_work_dict):
    elapsed_time_ops_dict = {}
    ops_dict = {}
    all_csv_file = do_cmd("find {} -iname *W.csv -print".format(archive_home), 30).strip()

    for each_csv in all_csv_file.split('\n'):
        cur_work_op_list = []
        work_id = each_csv.split('/')[-2].split('-')[0]
        ops_info = do_cmd("cat '{}' | awk '{{print $1}}' | awk -F ',' '{{print $14}}' | grep -v Throughput".format(each_csv), 30).strip() 
        sum_ops = sum(map(float, ops_info.split("\n")))
        
        ops_dict[work_id] = sum(map(float, ops_info.split("\n")))

        for each_key in all_work_dict.items():
            start_at = each_key[1][0]
            stop_at = each_key[1][1]
            if start_at and stop_at:
                start = datetime.strptime(start_at, '%H:%M:%S')
                end = datetime.strptime(stop_at, '%H:%M:%S')
                elapsed_time = (end-start).seconds
            else:
                elapsed_time_dict[each_key[0]] = 0

            if each_key[0] == work_id:
                time_and_ops = '{}/{}'.format(sum_ops, elapsed_time)
                elapsed_time_ops_dict[work_id] = time_and_ops
    sorted(elapsed_time_ops_dict.items(), lambda x, y: cmp(x[0], y[0]))
    return elapsed_time_ops_dict



if __name__ == '__main__':
    archive_home = "/root//0.4.2.c4/archive/"
    ls_info = do_cmd("ls -l {}".format(archive_home), 30, True).split('\n')

    if not os.path.exists(archive_home):
        print "\n    [ERROR]  Not find cosbench archive path, exit!\n"
        sys.exit(0)
    elif 'total 0' in ls_info:
        print "\n    [ERROR]  Not find cosbench archive files, exit!\n"
        sys.exit(0)

    all_work_dict = get_start_end_time()
    # elapsed_time_dict = calc_elapsed_time(all_work_dict)
    # ops = calc_ops()

    time_and_ops = calc_elapsed_time_ops(all_work_dict)
    # print("All work dict is : ({})\n".format(all_work_dict))
    # print("Elapsed time is : ({})\n".format(elapsed_time_dict))
    # print("OPS is : ({})\n".format(ops))
    print("OPS and elapsed time is : ({})\n".format(time_and_ops))
</code></pre></div></div>

<h1 id="è¾“å‡ºä¿¡æ¯">è¾“å‡ºä¿¡æ¯</h1>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@fireware:~# python calc_cosbench_task_time.py 
OPS and elapsed time is : ({'w11': '2504.92/4070', 'w10': '2514.82/4060', 'w7': '2519.07/4050', 'w6': '2579.88/3960', 'w5': '2593.13/3940', 'w4': '2606.27/3910', 'w3': '2636.37/3870', 'w2': '2623.56/3890', 'w1': '5387.47/1890', 'w9': '2540.3/4010', 'w8': '2524.32/4050'})

root@fireware:~#
</code></pre></div></div>

<p>è¯´æ˜ï¼š
*åå‡ºçš„ä¿¡æ¯ä¸­ï¼Œä»¥â€œâ€™w11â€™: â€˜2504.92/4070â€™â€ä¸ºç¤ºä¾‹ï¼š</p>
<ul>
  <li>
    <ul>
      <li>w11ï¼Œè¡¨ç¤ºçš„æ˜¯cosbenchçš„w11è¿™ä¸ªä»»åŠ¡</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>2504.92/4070, è¡¨ç¤ºè¿™ä¸ªä»»åŠ¡çš„IOPSæ˜¯2504.92ï¼Œè€—æ—¶äº†4070ç§’</li>
    </ul>
  </li>
</ul>

:ET