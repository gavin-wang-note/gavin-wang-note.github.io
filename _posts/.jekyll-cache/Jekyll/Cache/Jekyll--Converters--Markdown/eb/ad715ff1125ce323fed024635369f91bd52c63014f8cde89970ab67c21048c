I"‘<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1>

<p>ddæ˜¯ä¸€ä¸ªç¥å¥‡çš„å‘½ä»¤ï¼Œå¯ä»¥å°†ç¡¬ç›˜é©±åŠ¨å™¨å¤åˆ¶åˆ°å¦ä¸€ä¸ªç¡¬ç›˜é©±åŠ¨å™¨ï¼Œå®Œå…¨å½’é›¶ç¡¬ç›˜é©±åŠ¨å™¨ç­‰ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦å¯åŠ¨ dd å‘½ä»¤ï¼Œå°±æ²¡æ³•æ˜¾ç¤ºå®ƒçš„è¿›åº¦ï¼Œåªæ˜¯ååœ¨å…‰æ ‡å¤„ï¼Œç›´åˆ°å‘½ä»¤æœ€ç»ˆå®Œæˆã€‚é‚£ä¹ˆå¦‚ä½•ç›‘æ§ddçš„è¿›å±•å‘¢ï¼Ÿæœ¬æ–‡ä»¥ubuntuç¯å¢ƒä¸ºä¾‹è¿›è¡Œé˜è¿°ã€‚</p>

<h1 id="æŸ¥çœ‹ddè¿›åº¦">æŸ¥çœ‹ddè¿›åº¦</h1>

<p>æ–°statusé€‰é¡¹æ·»åŠ åˆ°ddï¼ˆGNU Coreutils 8.24+ï¼‰
ddåœ¨GNU Coreutils 8.24+ï¼ˆUbuntu 16.04åŠæ›´é«˜ç‰ˆæœ¬ï¼‰ä¸­ï¼Œæœ‰ä¸€ä¸ªæ–°statusé€‰é¡¹å¯ä»¥æ˜¾ç¤ºè¿›åº¦ï¼š</p>

<p>ç¤ºä¾‹ï¼š</p>

<p><code class="highlighter-rouge">dd if=/dev/urandom of=/dev/null status=progress</code></p>

<p>è¾“å‡ºä¿¡æ¯ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>462858752 bytes (463 MB, 441 MiB) copied, 38 s, 12,2 MB/s
</code></pre></div></div>

<h1 id="ä½¿ç”¨killè·å–è¿›åº¦">ä½¿ç”¨killè·å–è¿›åº¦</h1>

<p><code class="highlighter-rouge">dd if=/dev/zero of=/tmp/zero.img bs=10M count=100000</code></p>

<p>æƒ³è¦æŸ¥çœ‹ä¸Šé¢çš„ddå‘½ä»¤çš„æ‰§è¡Œè¿›åº¦ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢å‡ ç§æ–¹æ³•ï¼š</p>

<p>æ¯”å¦‚ï¼šæ¯5ç§’è¾“å‡ºddçš„è¿›åº¦</p>

<p>æ–¹æ³•ä¸€ï¼š</p>

<p><code class="highlighter-rouge">watch -n 5 pkill -USR1 ^dd$</code></p>

<p>æ–¹æ³•äºŒï¼š</p>

<p><code class="highlighter-rouge">watch -n 5 killall -USR1 dd</code></p>

<p>æ–¹æ³•ä¸‰ï¼š</p>

<p><code class="highlighter-rouge">while killall -USR1 dd; do sleep 5; done</code></p>

<p>æ–¹æ³•å››ï¼š</p>

<p><code class="highlighter-rouge">while (ps auxww |grep " dd " |grep -v grep |awk '{print $2}' |while read pid; do kill -USR1 $pid; done) ; do sleep 5; done</code></p>

<p>æ–¹æ³•äº”ï¼š</p>

<p><code class="highlighter-rouge">dd if=/path/to/bigimage of=/path/to/newimage conv=sparse bs=262144 &amp; bgid=$!; while true; do sleep 1; kill -USR1 $bgid || break; sleep 4; done</code></p>

<p>ä¸Šé¢è¿™ä¸ªå‘½ä»¤ï¼Œç³…åˆäº†å…·ä½“çš„ddå‘½ä»¤ï¼Œç„¶åkillå®ƒæ¥æ˜¾ç¤ºè¿›åº¦</p>

<p><img class="shadow" src="/img/in-post/dd_output_progress.png" width="1200" /></p>

<h1 id="pvæ˜¾ç¤ºè¿›åº¦">pvæ˜¾ç¤ºè¿›åº¦</h1>

<p>é¢˜å¤–è¯ï¼š</p>

<p>pvä¸ä»…ä»…æœ‰æ˜¾ç¤ºè¿›åº¦çš„åŠŸèƒ½ï¼Œè¿˜æœ‰ç»“åˆddæ¥é™åˆ¶ddè¯»å†™é€Ÿåº¦ï¼Œ e.g:</p>

<p><code class="highlighter-rouge">pv --rate-limit 2M -q -cN source &lt; /dev/zero |dd of=off_file bs=1M count=1024 iflag=fullblock</code></p>

<p>éæœ¬æ–‡è¦é˜è¿°çš„å†…å®¹ï¼Œæœ‰å…´è¶£çš„å¯ä»¥man pvæŸ¥çœ‹ä½¿ç”¨æ‰‹å†Œã€‚</p>

<p>å¦‚æœæ²¡æœ‰pvï¼Œæ‰§è¡Œä¸‹åˆ—å‘½ä»¤è¿›è¡Œå®‰è£…</p>

<p><code class="highlighter-rouge">apt-get install pv</code></p>

<h2 id="åˆ›å»ºbashåŒ…è£…å™¨ä½¿ç”¨pvæ¥æ˜¾ç¤ºè¿›åº¦">åˆ›å»ºbashåŒ…è£…å™¨ï¼Œä½¿ç”¨pvæ¥æ˜¾ç¤ºè¿›åº¦</h2>

<p>åœ¨.bashrcä¸­å¢åŠ åŒ…è£…å™¨,å°†ä¸‹é¢å†…å®¹æ”¾å…¥.bashrcæ–‡ä»¶</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dd()
{
    local dd=$(which dd); [ "$dd" ] || {
        echo "'dd' is not installed!" &gt;&amp;2
        return 1
    }

    local pv=$(which pv); [ "$pv" ] || {
        echo "'pv' is not installed!" &gt;&amp;2
        "$dd" "$@"
        return $?
    }

    local arg arg2 infile
    local -a args
    for arg in "$@"
    do
        arg2=${arg#if=}
        if [ "$arg2" != "$arg" ]
        then
            infile=$arg2
        else
            args[${#args[@]}]=$arg
        fi
    done

    "$pv" -tpreb "$infile" | "$dd" "${args[@]}"
}
</code></pre></div></div>

<p>sourceä¸€ä¸‹.bashrc</p>

<p>ä¹‹åå†æ¥ä½¿ç”¨ddå‘½ä»¤ï¼Œå°±å¯ä»¥çœ‹åˆ°è¿›åº¦äº†~</p>

<h2 id="ç›´æ¥å‘½ä»¤è¡Œç”¨pvæ˜¾ç¤ºè¿›åº¦">ç›´æ¥å‘½ä»¤è¡Œç”¨pvæ˜¾ç¤ºè¿›åº¦</h2>

<p>ç¤ºä¾‹ï¼š</p>

<p><code class="highlighter-rouge">dd if=/dev/urandom | pv | dd of=/dev/null</code></p>

<p>è¾“å‡ºï¼š</p>

<p><code class="highlighter-rouge">44.2MB 0:00:04 [11.4MB/s] [         &lt;=&gt;                                ]</code></p>

<p>å¦‚æœæƒ³è¦æ—¶é—´ä¼°ç®—ï¼Œå¯ä»¥ä½¿ç”¨ â€“size æŒ‡å®šè¿‘ä¼¼å¤§å°ï¼š</p>

<p><code class="highlighter-rouge">dd if=/dev/urandom | pv -s 2G| dd of=/dev/null</code></p>

<p><img class="shadow" src="/img/in-post/pv_size.png" width="1200" /></p>

<p>ç¤ºä¾‹ï¼š</p>

<p>å†™ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶æ˜¾ç¤ºè¿›åº¦ï¼š</p>

<p><code class="highlighter-rouge">pv -cN source &lt; /dev/zero | dd of=1g bs=100k count=10240</code></p>

<p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@host245:~/tmp# pv -cN source &lt; /dev/zero | dd of=1g bs=100k count=10240
   source:  960MB 0:00:01 [ 627MB/s] [         &lt;=&gt;                                                                                                                                                                                                                           ]
7680+2560 records in
7680+2560 records out
1006632960 bytes (1.0 GB) copied, 4.18198 s, 241 MB/s
root@host245:~/tmp# 
</code></pre></div></div>

<h2 id="ä½¿ç”¨pvé…åˆdialogè¿˜å¯ä»¥æ˜¾ç¤ºè¿›åº¦æ¡å¯¹è¯æ¡†">ä½¿ç”¨pvé…åˆdialogè¿˜å¯ä»¥æ˜¾ç¤ºè¿›åº¦æ¡å¯¹è¯æ¡†ï¼š</h2>

<p>éœ€è¦äº‹å…ˆå®‰è£…dialog</p>

<p><code class="highlighter-rouge">apt-get install dialog</code></p>

<p><code class="highlighter-rouge">(pv -n /dev/sda | dd of=/dev/zero bs=128M) 2&gt;&amp;1 | dialog --gauge "dd process bar" 10 70 0</code></p>

<p><img class="shadow" src="/img/in-post/pv_dialog.png" width="1200" /></p>

<p>ç¤ºä¾‹ï¼š</p>

<p>å…‹éš†ç£ç›˜é©±åŠ¨å™¨ï¼š</p>

<p><code class="highlighter-rouge">(pv -n /dev/sda | dd of=/dev/sdh bs=128M conv=notrunc,noerror) 2&gt;&amp;1 | dialog --gauge "Running dd command (cloning), please wait..." 10 70 0</code></p>

:ET