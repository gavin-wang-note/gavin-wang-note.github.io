I"±#<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1>

<p>æµ‹è¯•ä¸­ç¢°åˆ°ç ´åRAIDæˆ–ä¸‹çº¿ç£ç›˜çš„åœºæ™¯ï¼Œéœ€è¦ä»è®¾å¤‡ä¸Šæ‹”ç›˜ï¼Œç„¶åç­‰äº§å“ä¾¦æµ‹åˆ°å¯¹åº”Diskæˆ–VDå¼‚å¸¸åï¼Œå†æ’å›å»ï¼ŒéªŒè¯ç¨‹åºä¾¦æµ‹åŠæ—¶æ€§æ˜¯å¦å­˜åœ¨é—®é¢˜ã€‚</p>

<p>ç”±äºè¦é¢‘ç¹çš„è¿›å‡ºæœºæˆ¿è¿›è¡Œè®¾å¤‡çš„æ‹”å‡ºä¸æ’å›æ“ä½œï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œæ˜¯å¦æœ‰æ›´ä¾¿æ·çš„æ–¹å¼è¿›è¡Œæ“ä½œå‘¢ï¼Ÿ</p>

<p>æœ¬æ–‡ä»‹ç»åŒäº‹æ¨èçš„ï¼Œåœ¨æœ‰çƒ­äº¤æ¢é©±åŠ¨å™¨æƒ…å†µä¸‹ï¼Œé€šè¿‡scsiçƒ­æ’æ‹”æŒ‡ä»¤ï¼ˆscsi remove-single-deviceï¼Œscsi add-single-deviceï¼‰ï¼Œç§»é™¤å’Œå›æ’æŸå—è®¾å¤‡ã€‚</p>

<h1 id="å®è·µ">å®è·µ</h1>

<h2 id="ç§»é™¤è®¾å¤‡">ç§»é™¤è®¾å¤‡</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 'scsi remove-single-device 0 0 17 0' &gt; /proc/scsi/scsi
</code></pre></div></div>

<h2 id="æ·»åŠ è®¾å¤‡">æ·»åŠ è®¾å¤‡</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 'scsi add-single-device 0 0 17 0' &gt; /proc/scsi/scsi
</code></pre></div></div>

<p>å…¶ä¸­ï¼Œ0 0 17 0 ä¸ºå¯¹åº”ç£ç›˜çš„ä¿¡æ¯ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@node75:~# lsscsi 
[0:0:0:0]    enclosu GIGABYTE S451 series      000a  -        
[0:0:1:0]    enclosu GIGABYTE S451 series      000a  -        
[0:0:17:0]   disk    ATA      INTEL SSDSC2KG48 0142  /dev/sdh 
[0:2:0:0]    disk    AVAGO    Gigabyte MR-3108 4.68  /dev/sdb 
[0:2:1:0]    disk    AVAGO    Gigabyte MR-3108 4.68  /dev/sde 
[0:2:2:0]    disk    AVAGO    Gigabyte MR-3108 4.68  /dev/sdc 
[0:2:3:0]    disk    AVAGO    Gigabyte MR-3108 4.68  /dev/sdd 
[1:0:0:0]    disk    ATA      INTEL SSDSC2KG24 0100  /dev/sdf 
[2:0:0:0]    disk    ATA      INTEL SSDSC2KG24 0100  /dev/sdg 
root@node75:~#
</code></pre></div></div>

<ul>
  <li>ç¬¬ä¸€åˆ—ï¼šSCSIè®¾å¤‡idï¼Œè¿™å››ä¸ªå­—æ®µåˆ†åˆ«å¯¹åº”ä¿¡æ¯ä¸ºï¼šhostadapter idï¼ŒSCSI channel on hostadapterï¼Œvd target IDï¼Œ LUN(åˆ†åˆ«å¯¹åº”æœ¬æ–‡çš„0ï¼Œ0ï¼Œ17ï¼Œ0)</li>
  <li>ç¬¬äºŒåˆ—ï¼šè®¾å¤‡ç±»å‹</li>
  <li>ç¬¬3ï¼Œ4ï¼Œ5åˆ—ï¼šè®¾å¤‡å‚å•†ï¼Œå‹å·ï¼Œç‰ˆæœ¬ä¿¡æ¯  (Vendor,Model,Rev)</li>
  <li>æœ€åä¸€åˆ—ï¼šRevï¼Œè®¾å¤‡ä¸»èŠ‚ç‚¹åï¼Œå¯ä»¥ç†è§£ä¸ºè®¾å¤‡åœ¨ç³»ç»Ÿä¸­çš„åç§°ï¼Œå¦‚æœæ˜¯ç£ç›˜ï¼Œåˆ™ä¸º/dev/sdxxx</li>
</ul>

<p>å•ç‹¬å±•ç¤ºä¸€ä¸‹è¿™é‡Œçš„ç¬¬ä¸‰åˆ—ï¼Œç¬¬å››åˆ—ï¼Œç¬¬äº”åˆ—ä¿¡æ¯ï¼š</p>

<table>
  <thead>
    <tr>
      <th><strong>ç¬¬ä¸‰åˆ—</strong></th>
      <th><strong>ç¬¬å››åˆ—</strong></th>
      <th><strong>ç¬¬äº”åˆ—</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>AVAGO</td>
      <td>Gigabyte MR-3108</td>
      <td>4.68</td>
    </tr>
  </tbody>
</table>

<p>åˆ†åˆ«å¯¹åº”ç€Vendorï¼ŒModelï¼Œ Revï¼Œå‚è€ƒå¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@node75:/proc/scsi# lsscsi -c
Attached devices: 
Host: scsi0 Channel: 00 Target: 00 Lun: 00
  Vendor: GIGABYTE Model: S451 series      Rev: 000a
  Type:   Enclosure                        ANSI SCSI revision: 05
Host: scsi0 Channel: 00 Target: 01 Lun: 00
  Vendor: GIGABYTE Model: S451 series      Rev: 000a
  Type:   Enclosure                        ANSI SCSI revision: 05
Host: scsi0 Channel: 00 Target: 17 Lun: 00
  Vendor: ATA      Model: INTEL SSDSC2KG48 Rev: 0142
  Type:   Direct-Access                    ANSI SCSI revision: 06
Host: scsi0 Channel: 02 Target: 00 Lun: 00
  Vendor: AVAGO    Model: Gigabyte MR-3108 Rev: 4.68
  Type:   Direct-Access                    ANSI SCSI revision: 05
Host: scsi0 Channel: 02 Target: 01 Lun: 00
  Vendor: AVAGO    Model: Gigabyte MR-3108 Rev: 4.68
  Type:   Direct-Access                    ANSI SCSI revision: 05
Host: scsi0 Channel: 02 Target: 02 Lun: 00
  Vendor: AVAGO    Model: Gigabyte MR-3108 Rev: 4.68
  Type:   Direct-Access                    ANSI SCSI revision: 05
Host: scsi0 Channel: 02 Target: 03 Lun: 00
  Vendor: AVAGO    Model: Gigabyte MR-3108 Rev: 4.68
  Type:   Direct-Access                    ANSI SCSI revision: 05
Host: scsi1 Channel: 00 Target: 00 Lun: 00
  Vendor: ATA      Model: INTEL SSDSC2KG24 Rev: 0100
  Type:   Direct-Access                    ANSI SCSI revision: 05
Host: scsi2 Channel: 00 Target: 00 Lun: 00
  Vendor: ATA      Model: INTEL SSDSC2KG24 Rev: 0100
  Type:   Direct-Access                    ANSI SCSI revision: 05
root@node75:/proc/scsi#
</code></pre></div></div>

<p>çƒ­æ’æ‹”ç£ç›˜åï¼Œå¯¹åº”çš„kern logä¿¡æ¯ç‰‡æ–­å‚è€ƒå¦‚ä¸‹:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Jul  9 13:46:46 node75 kernel: [ 8752.867575] sd 0:0:17:0: SCSI device is removed
Jul  9 13:46:46 node75 kernel: [ 8752.867895] [830035]: scst: scst_unregister_device:1188:Detached from scsi0, channel 0, id 17, lun 0, type 0
Jul  9 13:46:46 node75 kernel: [ 8752.868087] print_req_error: I/O error, dev sda, sector 0
Jul  9 13:46:46 node75 kernel: [ 8752.875385] sd 0:0:17:0: [sda] Synchronizing SCSI cache
Jul  9 13:46:46 node75 kernel: [ 8752.875497] sd 0:0:17:0: [sda] Synchronize Cache(10) failed: Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
Jul  9 13:46:46 node75 kernel: [ 8752.895282] megaraid_sas 0000:af:00.0: scanning for scsi0...
Jul  9 13:46:48 node75 kernel: [ 8754.164633] scsi 0:0:17:0: Direct-Access     ATA      INTEL SSDSC2KG48 0142 PQ: 0 ANSI: 6
Jul  9 13:46:48 node75 kernel: [ 8754.166811] sd 0:0:17:0: Attached scsi generic sg2 type 0
Jul  9 13:46:48 node75 kernel: [ 8754.166818] sd 0:0:17:0: [sdh] 937703088 512-byte logical blocks: (480 GB/447 GiB)
Jul  9 13:46:48 node75 kernel: [ 8754.166821] sd 0:0:17:0: [sdh] 4096-byte physical blocks
Jul  9 13:46:48 node75 kernel: [ 8754.166838] [830035]: scst: scst_register_device:1102:Attached to scsi0, channel 0, id 17, lun 0, type 0
Jul  9 13:46:48 node75 kernel: [ 8754.167729] sd 0:0:17:0: [sdh] Write Protect is off
Jul  9 13:46:48 node75 kernel: [ 8754.167731] sd 0:0:17:0: [sdh] Mode Sense: 9b 00 10 08
Jul  9 13:46:48 node75 kernel: [ 8754.168049] sd 0:0:17:0: [sdh] Write cache: enabled, read cache: enabled, supports DPO and FUA
Jul  9 13:46:48 node75 kernel: [ 8754.174319]  sdh: sdh1 sdh2
Jul  9 13:46:48 node75 kernel: [ 8754.176615] sd 0:0:17:0: [sdh] Attached SCSI disk
Jul  9 13:46:48 node75 kernel: [ 8754.739509] blk_partition_remap: fail for partition 2
Jul  9 13:46:48 node75 kernel: [ 8754.739514] EXT4-fs error (device sda2): ext4_find_entry:1455: inode #2: comm ezrpcd: reading directory lblock 0
Jul  9 13:46:52 node75 kernel: [ 8758.867351] sd 0:0:17:0: SCSI device is removed
Jul  9 13:46:52 node75 kernel: [ 8758.867648] [830035]: scst: scst_unregister_device:1188:Detached from scsi0, channel 0, id 17, lun 0, type 0
Jul  9 13:46:52 node75 kernel: [ 8758.872546] sd 0:0:17:0: [sdh] Synchronizing SCSI cache
Jul  9 13:46:52 node75 kernel: [ 8758.872627] sd 0:0:17:0: [sdh] Synchronize Cache(10) failed: Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
Jul  9 13:46:52 node75 kernel: [ 8758.897329] megaraid_sas 0000:af:00.0: scanning for scsi0...
Jul  9 13:46:57 node75 kernel: [ 8763.163262] scsi 0:0:17:0: Direct-Access     ATA      INTEL SSDSC2KG48 0142 PQ: 0 ANSI: 6
Jul  9 13:46:57 node75 kernel: [ 8763.165348] sd 0:0:17:0: Attached scsi generic sg2 type 0
Jul  9 13:46:57 node75 kernel: [ 8763.165372] [830035]: scst: scst_register_device:1102:Attached to scsi0, channel 0, id 17, lun 0, type 0
Jul  9 13:46:57 node75 kernel: [ 8763.166274] sd 0:0:17:0: [sdh] 937703088 512-byte logical blocks: (480 GB/447 GiB)
Jul  9 13:46:57 node75 kernel: [ 8763.166279] sd 0:0:17:0: [sdh] 4096-byte physical blocks
Jul  9 13:46:57 node75 kernel: [ 8763.166558] sd 0:0:17:0: [sdh] Write Protect is off
Jul  9 13:46:57 node75 kernel: [ 8763.166561] sd 0:0:17:0: [sdh] Mode Sense: 9b 00 10 08
Jul  9 13:46:57 node75 kernel: [ 8763.166893] sd 0:0:17:0: [sdh] Write cache: enabled, read cache: enabled, supports DPO and FUA
Jul  9 13:46:57 node75 kernel: [ 8763.175450]  sdh: sdh1 sdh2
Jul  9 13:46:57 node75 kernel: [ 8763.177604] sd 0:0:17:0: [sdh] Attached SCSI disk
</code></pre></div></div>

<p>BTWï¼Œæœ¬ç¤ºä¾‹ä¸­ï¼Œ0:0:17:0: [sdh] æ˜¯ä¸€å—SSDï¼ŒåšæˆJBODæ¨¡å¼ï¼Œå½“JBODå¯¹åº”ç›˜æ­£å¸¸åœ¨è®¾å¤‡ä¸Šè¿è¡Œæ—¶ï¼Œæ˜¯ä¸æ”¯æŒMegacli/storcliä¸‹çº¿ç£ç›˜æŒ‡ä»¤çš„ï¼Œä¸€æ—¦æ‰§è¡ŒæŠ¥é”™ä¿¡æ¯å‚è€ƒå¦‚ä¸‹:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@node75:~# storcli64 /c0/e1/s17 set offline
Controller = 0
Status = Failure
Description = No drive found!

Detailed Status :
===============

-----------------------------------------
Drive      Status  ErrCd ErrMsg
-----------------------------------------
/c0/e1/s17 Failure   255 Drive not found
-----------------------------------------


root@node75:~#
</code></pre></div></div>

<h1 id="å…¶ä»–">å…¶ä»–</h1>

<p>ä¸Šæ–‡ä¸­çš„çƒ­æ’æ‹”ï¼Œå’Œ â€˜Rescan SCSI/SATA Host Busâ€™ æœ‰ç€å¼‚æ›²åŒå·¥ä¹‹å¤„ï¼Œæ¯•ç«Ÿæ–¹æ³•éƒ½æ˜¯å¤šæ ·çš„ï¼Œï¼Œæ ¹æ®ä¸åŒåœºåˆä½¿ç”¨ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#/bin/bash
# ReScan all SCSI/SATA Hosts
for SHOST in /sys/class/scsi_host/host*; do
    echo -n "Scanning ${SHOST##*/}..."
    echo "- - -" &gt; ${SHOST}/scan
    echo Done
done
</code></pre></div></div>

:ET