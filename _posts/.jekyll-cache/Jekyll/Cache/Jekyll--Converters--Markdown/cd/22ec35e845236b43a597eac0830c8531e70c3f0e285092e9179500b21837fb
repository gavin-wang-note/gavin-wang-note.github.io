I"å[<h2 id="rmanç®€ä»‹">RMANç®€ä»‹</h2>

<p>RMAN å¯ä»¥ç”¨æ¥å¤‡ä»½å’Œæ¢å¤æ•°æ®åº“æ–‡ä»¶ã€å½’æ¡£æ—¥å¿—å’Œæ§åˆ¶æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ‰§è¡Œå®Œå…¨æˆ–ä¸å®Œå…¨çš„æ•°æ®åº“æ¢å¤ã€‚RMANæœ‰ä¸‰ç§ä¸åŒçš„ç”¨æˆ·æ¥å£ï¼šCOMMAND LINEæ–¹å¼ã€GUI æ–¹å¼ï¼ˆé›†æˆåœ¨OEM ä¸­çš„å¤‡ä»½ç®¡ç†å™¨ï¼‰ã€API æ–¹å¼ï¼ˆç”¨äºé›†æˆåˆ°ç¬¬ä¸‰æ–¹çš„å¤‡ä»½è½¯ä»¶ä¸­ï¼‰ã€‚å…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>

<p>1ï¼‰åŠŸèƒ½ç±»ä¼¼ç‰©ç†å¤‡ä»½ï¼Œä½†æ¯”ç‰©ç†å¤‡ä»½å¼ºå¤§Nå€ï¼Œä»ä¸‹é¢çš„ç‰¹ç‚¹å¯ä»¥çœ‹åˆ°ï¼›</p>

<p>2ï¼‰å¯ä»¥å‹ç¼©ç©ºå—ï¼›</p>

<p>3ï¼‰å¯ä»¥åœ¨å—æ°´å¹³ä¸Šå®ç°å¢é‡ï¼›</p>

<p>4ï¼‰å¯ä»¥æŠŠå¤‡ä»½çš„è¾“å‡ºæ‰“åŒ…æˆå¤‡ä»½é›†ï¼Œä¹Ÿå¯ä»¥æŒ‰å›ºå®šå¤§å°åˆ†å‰²å¤‡ä»½é›†ï¼›</p>

<p>5ï¼‰å¤‡ä»½ä¸æ¢å¤çš„è¿‡ç¨‹å¯ä»¥è‡ªåŠ¨ç®¡ç†ï¼›</p>

<p>6ï¼‰å¯ä»¥ä½¿ç”¨è„šæœ¬ï¼ˆå­˜åœ¨Recovery catalog ä¸­ï¼‰</p>

<p>7ï¼‰å¯ä»¥åšåå—ç›‘æµ‹</p>

<h2 id="rmanå¤‡ä»½å½¢å¼">RMANå¤‡ä»½å½¢å¼</h2>

<p>RMANå¤‡ä»½æœ‰ä¸¤ç§å½¢å¼ï¼š</p>

<p>1ã€é•œåƒå¤‡ä»½ï¼ˆimage copiesï¼‰ï¼›</p>

<p>2ã€å¤‡ä»½é›†å¤‡ä»½ï¼ˆbackup setsï¼‰ã€‚</p>

<h3 id="é•œåƒå¤‡ä»½">é•œåƒå¤‡ä»½</h3>

<p>é•œåƒå¤‡ä»½å®é™…å°±æ˜¯RMANåˆ©ç”¨ç›®æ ‡æ•°æ®åº“æœåŠ¡è¿›ç¨‹æ¥å®Œæˆæ–‡ä»¶çš„copyæ“ä½œï¼Œæ˜¯æ•°æ®æ–‡ä»¶ã€æ§åˆ¶æ–‡ä»¶æˆ–è€…å½’æ¡£æ—¥å¿—æ–‡ä»¶çš„å‰¯æœ¬ã€‚</p>

<p>RMANé•œåƒå¤‡ä»½çš„å‰¯æœ¬æ— æ³•é€šè¿‡list backupæ˜¾ç¤ºï¼Œå¯ä»¥é€šè¿‡list copyæ˜¾ç¤ºã€‚</p>

<p>æœ¬æ–‡ä¸»è¦æè¿°å¤‡ä»½é›†å¤‡ä»½ã€‚</p>

<h3 id="å¤‡ä»½é›†å¤‡ä»½">å¤‡ä»½é›†å¤‡ä»½</h3>

<p>å¤‡ä»½é›†æ˜¯é€šè¿‡RMANåˆ›å»ºçš„é€»è¾‘å¤‡ä»½å¯¹è±¡ï¼Œä¸€ä¸ªå¤‡ä»½é›†ä¸­å¯ä»¥åŒ…æ‹¬å¤šä¸ªæ§åˆ¶æ–‡ä»¶ã€æ•°æ®æ–‡ä»¶ã€å½’æ¡£æ–‡ä»¶ã€‚</p>

<p>å¤‡ä»½é›†åœ¨ç‰©ç†ä¸Šç”±å¤šä¸ªå¤‡ä»½ç‰‡æ®µç»„æˆï¼Œæ¯ä¸ªå¤‡ä»½ç‰‡æ®µå°±æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿæ–‡ä»¶ã€‚</p>

<h2 id="rmanå¤‡ä»½ç±»å‹">RMANå¤‡ä»½ç±»å‹</h2>

<p>åˆ©ç”¨RMANè¿›è¡Œå¤‡ä»½æ—¶ï¼Œå¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼æ¥å¯¹RMANçš„å¤‡ä»½åšåˆ†ç±»</p>

<h3 id="å®Œå…¨å¤‡ä»½full-backupä¸å¢é‡å¤‡ä»½incremental-backup">å®Œå…¨å¤‡ä»½(Full Backup)ä¸å¢é‡å¤‡ä»½(Incremental Backup)</h3>

<p>å…¨å¤‡ä¸å¢å¤‡æ˜¯é’ˆå¯¹æ•°æ®æ–‡ä»¶è€Œè¨€ï¼Œæ§åˆ¶æ–‡ä»¶å’Œå½’æ¡£æ—¥å¿—æ–‡ä»¶ä¸èƒ½è¿›è¡Œå¢é‡å¤‡ä»½ã€‚å½“ç„¶ï¼Œåä¸¤è€…å¯ä»¥åšå¤‡ä»½ä¼˜åŒ–ã€‚</p>

<h3 id="æ‰“å¼€å¤‡ä»½open-backupæˆ–å…³é—­å¤‡ä»½closed-backup">æ‰“å¼€å¤‡ä»½(Open Backup)æˆ–å…³é—­å¤‡ä»½(Closed Backup)</h3>

<p>æ•°æ®åº“æ‰“å¼€çŠ¶æ€ä¸‹è¿›è¡Œå¤‡ä»½å³æ˜¯æ‰“å¼€å¤‡ä»½ï¼Œæ•°æ®åº“å…³é—­çŠ¶æ€ä¸‹(åŠ è½½çŠ¶æ€)è¿›è¡Œçš„å¤‡ä»½å³å…³é—­å¤‡ä»½ã€‚</p>

<h3 id="ä¸€è‡´å¤‡ä»½consistent-backupä¸ä¸ä¸€è‡´å¤‡ä»½inconsistent-backup">ä¸€è‡´å¤‡ä»½(Consistent Backup)ä¸ä¸ä¸€è‡´å¤‡ä»½(Inconsistent Backup)</h3>

<p>æ•°æ®åº“æ‰“å¼€çŠ¶æ€æˆ–ä¸å¹²å‡€å…³é—­çŠ¶æ€(shutdown abort)è¿›è¡Œçš„å¤‡ä»½æ˜¯ä¸ä¸€è‡´å¤‡ä»½ï¼Œåˆ©ç”¨ä¸ä¸€è‡´çš„å¤‡ä»½ä¿®å¤æ•°æ®åº“åè¿˜éœ€è¦åšæ•°æ®åº“çš„æ¢å¤ã€‚åœ¨æ•°æ®åº“å¹²å‡€å…³é—­çŠ¶æ€è¿›è¡Œçš„å¤‡ä»½æ˜¯ä¸€è‡´å¤‡ä»½ï¼Œåˆ©ç”¨ä¸€è‡´å¤‡ä»½ä¿®å¤æ•°æ®åº“åä¸éœ€è¦åšæ•°æ®åº“çš„æ¢å¤ã€‚</p>

<h2 id="rman-report-list-deleteå‘½ä»¤è¯¦è§£">RMAN report list deleteå‘½ä»¤è¯¦è§£</h2>

<h3 id="report">report</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. æŠ¥å‘Šç›®æ ‡æ•°æ®åº“çš„ç‰©ç†ç»“æ„              RMAN&gt; report schema;

2. æŠ¥å‘Šæœ€è¿‘Nå¤©å°šæœªå¤‡ä»½çš„æ•°æ®æ–‡ä»¶           RMAN&gt; report need backup days=3;

3. æŠ¥å‘Šè¡¨ç©ºé—´ä¸Šæœ€è¿‘Nå¤©æœªå¤‡ä»½çš„æ•°æ®æ–‡ä»¶         RMAN&gt; report need backup days=3 tablespace MMSG;

4. æŠ¥å‘Šæ¢å¤æ•°æ®æ–‡ä»¶éœ€è¦çš„å¢é‡å¤‡ä»½ä¸ªæ•°è¶…è¿‡3æ¬¡çš„æ•°æ®æ–‡ä»¶ RMAN&gt; report need backup incremental 3;

5. æŠ¥å‘Šå¤‡ä»½æ–‡ä»¶ä½äº2ä»½çš„æ‰€æœ‰æ•°æ®æ–‡ä»¶         RMAN&gt; report need backup redundancy 2 database;

6. æŠ¥å‘Šæ–‡ä»¶æŠ¥è¡¨çš„æ¢å¤éœ€è¦è¶…è¿‡6å¤©çš„å½’æ¡£æ—¥å¿—çš„æ•°æ®æ–‡ä»¶  RMAN&gt; report need backup recovery window of 6 days;

7. æŠ¥å‘Šæ•°æ®åº“æ‰€æœ‰ä¸å¯æ¢å¤çš„æ•°æ®æ–‡ä»¶          RMAN&gt; report unrecoverable;

8. æŠ¥å‘Šå¤‡ä»½æ¬¡æ•°è¶…è¿‡2æ¬¡çš„é™ˆæ—§å¤‡ä»½           RMAN&gt; report obsolete redundancy 2;

9. æŠ¥å‘Šå¤šä½™çš„å¤‡ä»½                  RMAN&gt; report obsolete;
</code></pre></div></div>

<h3 id="list">list</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>list backup;             åˆ—å‡ºè¯¦ç»†å¤‡ä»½

list expired backup;         åˆ—å‡ºè¿‡æœŸå¤‡ä»½

list backup of database;       åˆ—å‡ºæ‰€æœ‰æ•°æ®æ–‡ä»¶çš„å¤‡ä»½é›†

list backup of tablespace MMSG;    åˆ—å‡ºç‰¹å®šè¡¨ç©ºé—´çš„æ‰€æœ‰æ•°æ®æ–‡ä»¶å¤‡ä»½é›†

list backup of controlfile;      åˆ—å‡ºæ§åˆ¶æ–‡ä»¶å¤‡ä»½é›†

list backup of archivelog all;    åˆ—å‡ºå½’æ¡£æ—¥å¿—å¤‡ä»½é›†è¯¦ç»†ä¿¡æ¯

list archivelog all;ã€€ã€€ã€€ã€€ã€€ã€€    åˆ—å‡ºå½’æ¡£æ—¥å¿—å¤‡ä»½é›†ç®€è¦ä¿¡æ¯

list backup of spfile;        åˆ—å‡ºSPFILEå¤‡ä»½é›†

list copy of datafile 5;       åˆ—å‡ºæ•°æ®æ–‡ä»¶æ˜ åƒå‰¯æœ¬

list copy of controlfile;       åˆ—å‡ºæ§åˆ¶æ–‡ä»¶æ˜ åƒå‰¯æœ¬

list copy of archivelog all;     åˆ—å‡ºå½’æ¡£æ—¥å¿—æ˜ åƒå‰¯æœ¬

list incarnation of database;     åˆ—å‡ºå¯¹åº”ç‰©/åˆ—å‡ºæ•°æ®åº“å‰¯æœ¬

list backup summary;         æ¦‚è¿°å¯ç”¨çš„å¤‡ä»½ï¼ˆBè¡¨ç¤ºbackupã€Fè¡¨ç¤ºFULLã€Aè¡¨ç¤ºarchive logã€Sè¯´æ˜å¤‡ä»½çŠ¶æ€ï¼ˆAã€€AVAILABLEã€€ã€€ã€€X EXPIRED )

list backup by file;         æŒ‰å¤‡ä»½ç±»å‹åˆ—å‡ºå¤‡ä»½

â€‹                   æŒ‰ç…§æ•°æ®æ–‡ä»¶å¤‡ä»½ï¼Œå½’æ¡£æ—¥å¿—å¤‡ä»½ï¼Œæ§åˆ¶æ–‡ä»¶å¤‡ä»½ï¼ŒæœåŠ¡å™¨å‚æ•°æ–‡ä»¶å¤‡ä»½ã€€åˆ—å‡º
</code></pre></div></div>

<h3 id="check">check</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMAN&gt; crosscheck backup;               æ ¸å¯¹æ‰€æœ‰å¤‡ä»½é›† 

RMAN&gt; crosscheck backup of database;         æ ¸å¯¹æ‰€æœ‰æ•°æ®æ–‡ä»¶çš„å¤‡ä»½é›† 

RMAN&gt; crosscheck backup of tablespace MMSG;      æ ¸å¯¹ç‰¹å®šè¡¨ç©ºé—´çš„å¤‡ä»½é›† 

RMAN&gt; crosscheck backup of datafile 4;        æ ¸å¯¹ç‰¹å®šæ•°æ®æ–‡ä»¶çš„å¤‡ä»½é›† 

RMAN&gt; crosscheck backup of controlfile;        æ ¸å¯¹æ§åˆ¶æ–‡ä»¶çš„å¤‡ä»½é›† 

RMAN&gt; crosscheck backup of spfile;          æ ¸å¯¹SPFILEçš„å¤‡ä»½é›† 

RMAN&gt; crosscheck backup of archivelog sequence 3;   æ ¸å¯¹å½’æ¡£æ—¥å¿—çš„å¤‡ä»½é›†

RMAN&gt; crosscheck copy;                 æ ¸å¯¹æ‰€æœ‰æ˜ åƒå‰¯æœ¬

RMAN&gt; crosscheck copy of database;          æ ¸å¯¹æ‰€æœ‰æ•°æ®æ–‡ä»¶çš„æ˜ åƒå‰¯æœ¬

RMAN&gt; crosscheck copy of tablespace MMSG;       æ ¸å¯¹ç‰¹å®šè¡¨ç©ºé—´çš„æ˜ åƒå‰¯æœ¬ 

RMAN&gt; crosscheck copy of datafile 6;         æ ¸å¯¹ç‰¹å®šæ•°æ®æ–‡ä»¶çš„æ˜ åƒå‰¯æœ¬ 

RMAN&gt; crosscheck copy of archivelog sequence 4;    æ ¸å¯¹å½’æ¡£æ—¥å¿—çš„æ˜ åƒå‰¯æœ¬ 

RMAN&gt; crosscheck copy of controlfile;         æ ¸å¯¹æ§åˆ¶æ–‡ä»¶çš„æ˜ åƒå‰¯æœ¬

RMAN&gt; crosscheck backup tag='SAT_BACKUP';

RMAN&gt; crosscheck backup completed after 'sysdate - 2';

RMAN&gt; crosscheck backup completed between 'sysdate - 5' and 'sysdate -2 ';

RMAN&gt; crosscheck backup device type sbt;

RMAN&gt; crosscheck archivelog all;

RMAN&gt; crosscheck archivelog like '%ARC00012.001';

RMAN&gt; crosscheck archivelog from sequence 12;

RMAN&gt; crosscheck archivelog until sequence 522;
</code></pre></div></div>

<h3 id="delete">delete</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMAN&gt; delete obsolete;         åˆ é™¤é™ˆæ—§å¤‡ä»½ï¼›

RMAN&gt; delete expired backup;      åˆ é™¤EXPIREDå¤‡ä»½ 

RMAN&gt; delete expired copy;       åˆ é™¤EXPIREDå‰¯æœ¬

RMAN&gt; delete backupset 19;       åˆ é™¤ç‰¹å®šå¤‡ä»½é›†

RMAN&gt; delete backuppiece '/opt/oracle/oradata/backup/test.ora';  åˆ é™¤ç‰¹å®šå¤‡ä»½ç‰‡

RMAN&gt; delete backup;          åˆ é™¤æ‰€æœ‰å¤‡ä»½é›†

RMAN&gt; delete datafilecopy '/opt/oracle/oradata/backup/test.bak'; åˆ é™¤ç‰¹å®šæ˜ åƒå‰¯æœ¬

RMAN&gt; delete copy;           åˆ é™¤æ‰€æœ‰æ˜ åƒå‰¯æœ¬

RMAN&gt; delete archivelog all delete input;

RMAN&gt; delete backupset 22 format = '/opt/oracle/oradata/backup/%u.bak' delete input;

â€‹                    åœ¨å¤‡ä»½ååˆ é™¤è¾“å…¥å¯¹è±¡      

RMAN&gt; delete backupset id;       åˆ é™¤å¤‡ä»½é›†
</code></pre></div></div>

<h2 id="rmanå¤‡ä»½">RMANå¤‡ä»½</h2>

<h3 id="å¤‡ä»½æ•´ä¸ªæ•°æ®åº“">å¤‡ä»½æ•´ä¸ªæ•°æ®åº“</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run {

allocate channel c1 type disk;

backup

full

tag full_db_backup

format "/opt/oracle/mmsg.load/db_t%t_s%s_p%p"

(database);

release channel c1;

}
</code></pre></div></div>

<h3 id="å¤‡ä»½æŒ‡å®šçš„æ•°æ®æ–‡ä»¶">å¤‡ä»½æŒ‡å®šçš„æ•°æ®æ–‡ä»¶</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>backup datafile '/opt/oracle/oradata/mmsgdb/test.dbf';
</code></pre></div></div>

<h3 id="å¤‡ä»½è¡¨ç©ºé—´">å¤‡ä»½è¡¨ç©ºé—´</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>backup tablespace MMSG;
</code></pre></div></div>

<h3 id="å¤‡ä»½æ§åˆ¶æ–‡ä»¶">å¤‡ä»½æ§åˆ¶æ–‡ä»¶</h3>

<p>æ–¹æ³•1ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>configure controlfile autobackup on;
</code></pre></div></div>

<p>æ–¹æ³•2ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>backup current controlfile;
</code></pre></div></div>

<p>æ–¹æ³•3:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>backup database include current controlfile;
</code></pre></div></div>

<h3 id="å¤‡ä»½å½’æ¡£æ—¥å¿—">å¤‡ä»½å½’æ¡£æ—¥å¿—</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>backup archivelog all;
</code></pre></div></div>

<h3 id="å¢é‡å¤‡ä»½">å¢é‡å¤‡ä»½</h3>

<p>å»ºç«‹ä¸€ä¸ªå¢é‡çº§åˆ«ä¸º0çš„å…¨åº“å¤‡ä»½ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> backup INCREMENTAL LEVEL=0 database;
</code></pre></div></div>

<p>å»ºç«‹ä¸€ä¸ªå¢é‡çº§åˆ«ä¸º1çš„æ•°æ®åº“è¡¨ç©ºé—´çš„å¤‡ä»½ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> backup incremental level=1 tablespace MMSG;
</code></pre></div></div>

<p>æ³¨ï¼š</p>

<ul>
  <li>Rmané»˜è®¤åˆ›å»ºçš„å¢é‡å¤‡ä»½æ˜¯Differentialæ–¹å¼ï¼Œå¦‚æœè¦å»ºç«‹Cumulativeæ–¹å¼çš„å¢é‡å¤‡ä»½ï¼Œåœ¨æ‰§è¡ŒBACKUPå‘½ä»¤æ—¶æ˜¾å¼æŒ‡å®šå³å¯ï¼Œä¾‹å¦‚ï¼š</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMAN&gt; BACKUP INCREMENTAL LEVEL=2 CUMULATIVE DATABASE;
</code></pre></div></div>

<h3 id="å†—ä½™å¤‡ä»½">å†—ä½™å¤‡ä»½</h3>

<p>æ­¥éª¤ä¸€ï¼šæ˜¾ç¤ºæŒ‡å®šcopiesæ•°é‡</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMAN&gt; backup copies 2 tablespace MMSG;
</code></pre></div></div>

<p>æ­¥éª¤äºŒï¼šåœ¨æ‰¹å¤„ç†ä¸­å¢åŠ set backup copieså‚æ•°ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMAN&gt; run

{

set backup copies 1;

allocate channel c1 device type disk;

backup tablespace MMSG;

}
</code></pre></div></div>

<p>æ­¥éª¤ä¸‰ï¼šé€šè¿‡configureè®¾å®šé¢„å¤‡ä»½Duplexedæ–¹å¼</p>

<h2 id="rmanæ¢å¤">RMANæ¢å¤</h2>

<h3 id="æ¢å¤spfileæ–‡ä»¶">æ¢å¤spfileæ–‡ä»¶</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMAN&gt; startup nomount

RMAN&gt; set dbid=1037536304

RMAN&gt; restore spfile from autobackup; #è¿™é‡Œconfile autobackupå¿…é¡»è®¾ç½®æˆon

RMAN&gt; startup force
</code></pre></div></div>

<h3 id="è¡¨ç©ºé—´çš„æ¢å¤">è¡¨ç©ºé—´çš„æ¢å¤</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMAN&gt; shutdown immediate

RMAN&gt;startup mount

RMAN&gt;restore tablespace "TEST"; #TESTä¸ºè¦æ¢å¤çš„è¡¨ç©ºé—´å

RMAN&gt;recover tablespace "TEST";

RMAN&gt;alter database open;
</code></pre></div></div>

<h3 id="æ•°æ®æ–‡ä»¶çš„æ¢å¤">æ•°æ®æ–‡ä»¶çš„æ¢å¤</h3>

<p>è¿™ä¸ªæ“ä½œç±»ä¼¼äºè¡¨ç©ºé—´çš„æ¢å¤</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMAN&gt;shutdown immediate

RMAN&gt;startup mount

RMAN&gt;restorer datafile datafilepath; #æˆ–è€…æ˜¯restore datafile datafile_num;

RMAN&gt;recover datafile datafilepath;  #æˆ–è€…æ˜¯recover datafile datafile_num;

RMAN&gt;alter database open
</code></pre></div></div>

<h3 id="å…¨åº“çš„æ¢å¤">å…¨åº“çš„æ¢å¤</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMAN&gt;shutdown immediate

RMAN&gt;startup mount

RMAN&gt; run

2&gt; {

3&gt; allocate channel c1 device type disk;

4&gt; restore database;

5&gt; }
</code></pre></div></div>

<h3 id="æ§åˆ¶æ–‡ä»¶çš„æ¢å¤">æ§åˆ¶æ–‡ä»¶çš„æ¢å¤</h3>

<p><strong>1</strong><strong>ã€æŸåéƒ¨åˆ†æ§åˆ¶æ–‡ä»¶</strong></p>

<p>æ­¥éª¤ä¸€ï¼šä½¿ç”¨dbvå‘½ä»¤æ£€æµ‹æ§åˆ¶æ–‡ä»¶æ˜¯å¦è¢«æŸåï¼Œå¦‚ï¼šdbv file=control02.ctl blocksize=16384</p>

<p>æ­¥éª¤äºŒï¼šcpå¥½çš„æ§åˆ¶æ–‡ä»¶ï¼Œå¹¶é‡å‘½å</p>

<p><strong>2</strong><strong>ã€æ‰€æœ‰æ§åˆ¶æ–‡ä»¶å‡è¢«æŸå</strong></p>

<p>æŸåæ‰€æœ‰çš„æ§åˆ¶æ–‡ä»¶æˆ–è€…äººä¸ºçš„åˆ é™¤æ‰€æœ‰çš„æ§åˆ¶æ–‡ä»¶ï¼Œé€šè¿‡å¤‡ä»½å¤åˆ¶å·²ç»ä¸èƒ½è§£å†³é—®é¢˜ï¼Œåªèƒ½é‡æ–°å»ºç«‹æ–°çš„æ§åˆ¶æ–‡ä»¶ã€‚</p>

<p>ä¿ç•™dbaç”¨æˆ·æ‰§è¡Œ alter database backup controlfile to trace äº§ç”Ÿçš„é‡å»ºæ§åˆ¶æ–‡ä»¶çš„å‘½ä»¤</p>

<p>æ­¥éª¤ä¸€:</p>

<p>å…³é—­æ•°æ®åº“ï¼Œä¿®æ”¹traceæ–‡ä»¶ä¸­åˆ›å»ºcontrolæ–‡ä»¶éƒ¨åˆ†ï¼Œdbaç”¨æˆ·æ‰§è¡Œè„šæœ¬é‡åˆ›æ§åˆ¶æ–‡ä»¶;</p>

<p>æ­¥éª¤äºŒ :</p>

<p>é‡å¯æ•°æ®åº“</p>

<p>å¦‚æœæ•°æ®åº“è¿è¡Œåœ¨å½’æ¡£æ¨¡å¼ä¸‹ï¼Œä¸”æœ‰æ§åˆ¶æ–‡ä»¶çš„å¤‡ä»½(CONFIGURE CONTROLFILE AUTOBACKUP ON)ï¼Œå¯ä»¥ä½¿ç”¨æœ‰å¯ç”¨çš„æ§åˆ¶æ–‡ä»¶çš„å¤‡ä»½ï¼Œåˆ™å¯ä»¥ä½¿ç”¨restore controlfile from â€˜å¤‡ä»½çš„æ§åˆ¶æ–‡ä»¶è·¯å¾„+æ–‡ä»¶åâ€™æ¥å®Œæˆæ§åˆ¶æ–‡ä»¶çš„æ¢å¤æ“ä½œ</p>

<p>1ã€æ•°æ®åº“å¯åŠ¨åˆ°éå®‰è£…çŠ¶æ€(nomount)</p>

<p>2ã€RMANæ¢å¤</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> RMAN&gt; run {

   allocate channel c1 device type disk;

   restore controlfile from â€˜/opt/oracle/rman/back_c-1037536304-20101123-07â€™;

   release channel c1;

   }
</code></pre></div></div>

<h3 id="é‡åšæ—¥å¿—æ–‡ä»¶çš„æ¢å¤">é‡åšæ—¥å¿—æ–‡ä»¶çš„æ¢å¤</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL&gt; shutdown immediate

æ•°æ®åº“å·²ç»å…³é—­ã€‚

å·²ç»å¸è½½æ•°æ®åº“ã€‚

ORACLE ä¾‹ç¨‹å·²ç»å…³é—­ã€‚

SQL&gt; startup mount

SQL&gt; recover database using backup controlfile until cancel;

SQL&gt; alter database open resetlogs;
</code></pre></div></div>

<h3 id="å½’æ¡£æ—¥å¿—æ–‡ä»¶çš„æ¢å¤">å½’æ¡£æ—¥å¿—æ–‡ä»¶çš„æ¢å¤</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMAN&gt;shutdown immediate

RMAN&gt;startup mount

RMAN&gt; run

2&gt; {

3&gt; allocate channel c1 device type disk;

4&gt; restore archivelog all;

5&gt; }
</code></pre></div></div>

<h3 id="æŸåéå½“å‰è”æœºæ—¥å¿—">æŸåéå½“å‰è”æœºæ—¥å¿—</h3>

<p>æ­¥éª¤ä¸€ å¯åŠ¨æ•°æ®åº“ï¼ŒæŠ¥é”™ï¼šORA-00313å’ŒORA-00312</p>

<p>æ­¥éª¤äºŒ æŸ¥çœ‹v$logè§†å›¾</p>

<p>æ­¥éª¤ä¸‰  ç”¨CLEARå‘½ä»¤é‡å»ºè¯¥æ—¥å¿—æ–‡ä»¶</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL&gt; alter database clear logfile group 3;
</code></pre></div></div>

<p>â€‹      å¦‚æœæ˜¯è¯¥æ—¥å¿—ç»„è¿˜æ²¡æœ‰å½’æ¡£ï¼Œåˆ™éœ€è¦ç”¨</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  SQL&gt;alter database clear unarchived logfile group 3;
</code></pre></div></div>

<p>æ­¥éª¤å››  æ‰“å¼€æ•°æ®åº“ï¼Œå¹¶å¤‡ä»½æ•°æ®åº“</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> SQL&gt; alter database open;
</code></pre></div></div>

<h3 id="æŸåå½“å‰è”æœºæ—¥å¿—">æŸåå½“å‰è”æœºæ—¥å¿—</h3>

<p>ä¸€ã€æ•°æ®åº“æ­£å¸¸å…³é—­ï¼Œæ—¥å¿—æ–‡ä»¶ä¸­æ²¡æœ‰æœªå†³çš„äº‹åŠ¡éœ€è¦å®ä¾‹æ¢å¤ï¼Œå½“å‰æ—¥å¿—ç»„çš„æŸåï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨alter database clear unarchived logfile group N;å‘½ä»¤æ¥é‡å»º</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  SQL&gt; alter database clear unarchived logfile group 2;

  SQL&gt; alter database open;
</code></pre></div></div>

<p>äºŒã€æ—¥å¿—ç»„ä¸­æœ‰æ´»åŠ¨äº‹åŠ¡ï¼Œéœ€è¦ä»‹è´¨æ¢å¤ï¼Œæ—¥å¿—ç»„éœ€è¦ç”¨æ¥æ•°æ®åŒæ­¥ï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š</p>

<p>1ã€é€šè¿‡ä¸å®Œå…¨æ¢å¤ï¼Œä¿æŒæ•°æ®åº“æ•°æ®ä¸€è‡´æ€§ï¼Œè¿™ç§æ–¹æ³•è¦æ±‚æ•°æ®åº“è¿è¡Œåœ¨å½’æ¡£æ–¹å¼ä¸‹ï¼Œä¸”æœ‰å¯ç”¨çš„æ•°æ®æ–‡ä»¶çš„å¤‡ä»½</p>

<p>æ­¥éª¤ä¸€ å¯åŠ¨æ•°æ®åº“ï¼ŒæŠ¥é”™ï¼šORA-00313 ï¼ŒORA-00312ï¼Œ ORA-27037</p>

<p>æ­¥éª¤äºŒ æ¨¡æ‹Ÿå½“å‰æ—¥å¿—ç»„ä¸­æ—¥å¿—æ–‡ä»¶æŸå SQL&gt; select * from v$log;</p>

<p>æ­¥éª¤ä¸‰ æ‹·è´æœ‰æ•ˆçš„å¤‡ä»½ï¼Œè¿›è¡Œä¸å®Œå…¨æ¢å¤ï¼ˆåŒ…æ‹¬æ‰€æœ‰çš„æ§åˆ¶æ–‡ä»¶ã€æ•°æ®æ–‡ä»¶ã€redoæ–‡ä»¶ï¼‰</p>

<p>æ­¥éª¤å›› æ•°æ®åº“å¯åŠ¨åˆ°mountçŠ¶æ€ï¼Œè¿›è¡Œä¸å®Œå…¨æ¢å¤ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      SQL&gt; startup mount

      SQL&gt; recover database until cancel;

      SQL&gt; alter database open resetlogs;
</code></pre></div></div>

<p>æ³¨ï¼šè¿™ä¸ªæ—¶å€™æ˜¯ä¸èƒ½ç”¨rmanè¿›è¡Œæ¢å¤çš„ï¼</p>

<p>2ã€é€šè¿‡å¼ºåˆ¶æ€§æ¢å¤ï¼Œè¿™ç§æ–¹æ³•ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´æ€§ï¼Œæ¨èä½¿ç”¨æ–¹æ³•ä¸€</p>

<p>æ­¥éª¤ä¸€ æ¨¡æ‹Ÿå½“å‰æ—¥å¿—ç»„ä¸­æ—¥å¿—æˆå‘˜è¢«æŸå SQL&gt; select * from v$log;</p>

<p>æ­¥éª¤äºŒ ä¿®æ”¹pfileæ–‡ä»¶ï¼Œå¢åŠ éšæ€§å‚æ•°</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> vi /opt/oracle/admin/mmsgdb/pfile/init.ora.232011183420

  \#add for test by wangyunzeng

  _allow_resetlogs_corruption=TRUE
</code></pre></div></div>

<p>æ­¥éª¤ä¸‰ é€šè¿‡pfileæ–‡ä»¶å¯åŠ¨æ•°æ®åº“</p>

<p>æ­¥éª¤å›› è¿›è¡Œä»‹è´¨æ¢å¤</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL&gt; recover database until cancel;
</code></pre></div></div>

<p>â€‹      å‡ºç°å¦‚ä¸‹ä¿¡æ¯æ—¶ï¼Œé€‰æ‹©cancelå‘½ä»¤  æŒ‡å®šæ—¥å¿—:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> {&lt;RET&gt;=suggested | filename | AUTO | CANCEL}
 cancel
</code></pre></div></div>

<p>æ­¥éª¤äº” resetlogsæ–¹å¼å¯åŠ¨æ•°æ®åº“</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL&gt; alter database open resetlogs;
</code></pre></div></div>

<p>æ­¥éª¤å…­ å…³é—­æ•°æ®åº“ï¼Œå»æ‰pfileæ–‡ä»¶ä¸­éšæ€§å‚æ•°ï¼Œé‡å¯æ•°æ®åº“ï¼ˆç›´æ¥æ‰§è¡Œstartupå‘½ä»¤å³å¯ï¼‰</p>

<p>æ­¥éª¤ä¸ƒ å¤‡ä»½æ•´ä¸ªæ•°æ®åº“  ç‰©ç†å†·å¤‡æˆ–è€…ç‰©ç†çƒ­å¤‡æˆ–è€…RMANå¤‡ä»½éƒ½è¡Œã€‚</p>

<p>æ­¥éª¤å…« å¯¼å…¥æ•°æ®   å¦‚æœæœ‰ç›¸å…³çš„expå¯¼å‡ºçš„æ•°æ®ï¼Œå¯ä»¥æ‰§è¡Œimpå¯¼å…¥æ“ä½œï¼Œæ¯•ç«Ÿæ•°æ®å‘ç”Ÿä¸¢å¤±ã€‚</p>

<p>æ­¥éª¤ä¹ è¡¨æ•°æ®åˆ†æ  å»ºè®®æ‰§è¡Œä¸€ä¸‹è¡¨åˆ†æ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL&gt; ANALYZE TABLE time VALIDATE STRUCTURE CASCADE;
</code></pre></div></div>

<h3 id="ä¸´æ—¶æ•°æ®æ–‡ä»¶çš„æ¢å¤">ä¸´æ—¶æ•°æ®æ–‡ä»¶çš„æ¢å¤</h3>

<p>ä¸´æ—¶æ•°æ®æ–‡ä»¶ä¸åŒ…å«æœ‰æ•ˆæ•°æ®ï¼Œå‘ç”Ÿä¸¢å¤±ååˆ é™¤åŸå…ˆä¸´æ—¶æ•°æ®æ–‡ä»¶å¹¶è¿›è¡Œé‡å»ºå°±å¯ä»¥äº†ã€‚</p>

<h2 id="rmanå®æˆ˜">RMANå®æˆ˜</h2>

<h3 id="å®æˆ˜1">å®æˆ˜1</h3>

<p>è¦æ±‚</p>

<p>1 ã€æ¯å¤©å¤œé—´1ç‚¹æ‰§è¡Œï¼›</p>

<p>2 ã€æ•°æ®åº“å…¨å¤‡ï¼ŒåŒæ—¶å¤‡ä»½æ§åˆ¶æ–‡ä»¶åŠå½’æ¡£æ—¥å¿—æ–‡ä»¶ï¼Œå¤‡ä»½æ–‡ä»¶ä¿å­˜è‡³ï¼š/opt/oracle/rmanç›®å½•ä¸‹ï¼Œå¹¶åœ¨å®Œæˆå½’æ¡£æ—¥å¿—æ–‡ä»¶å¤‡ä»½åï¼Œè‡ªåŠ¨åˆ é™¤å·²å¤‡ä»½çš„å½’æ¡£æ—¥å¿—ï¼›</p>

<p>3 ã€å¤‡ä»½ä¿ç•™7å¤©ï¼Œè¿‡æœŸåˆ™è‡ªåŠ¨åˆ é™¤ï¼›</p>

<p>4 ã€ä¿ç•™æ“ä½œæ—¥å¿—å¤‡æŸ¥ï¼›</p>

<p>RMANè„šæœ¬</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oracle@mmsg:~/rman&gt; more back_full.rman

run

{

configure retention policy to recovery window of 7 days;

configure controlfile autobackup on;

configure controlfile autobackup format for device type disk to '/opt/oracle/rman/full_bak_%F';

allocate channel c1 device type disk format '/opt/oracle/rman/full_bak_%U';

backup database skip inaccessible filesperset 10 plus archivelog filesperset 20 delete all input;

release channel c1;

}

allocate channel for maintenance device type disk;

crosscheck backupset;

delete noprompt obsolete;
</code></pre></div></div>

<p>å‘½ä»¤æ‰§è¡Œ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oracle@mmsg:~/rman&gt; rman target / msglog /opt/oracle/rman/bak.log cmdfile=/opt/oracle/rman/back_full.rman
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oracle@mmsc103:~/rmanbak&gt; more backup.pl

#!/usr/bin/perl

###    ä½œç”¨ï¼šrmanå®šæ—¶ä»»åŠ¡è„šæœ¬       ###

#è·å–ç³»ç»Ÿå½“å‰æ—¶é—´

my ($sec,$min,$hour,$day,$month,$year)= localtime(time());

$year+=1900;

$month=sprintf("%02d",$month+1);

$day=sprintf("%02d",$day);

$hour=sprintf("%02d",$hour);

$min=sprintf("%02d",$min);

$sec=sprintf("%02d",$sec);

my $daytime = "$year$month$day$hour$min$sec";

system("/opt/oracle/product/11g/bin/rman  cmdfile = '/opt/oracle/rmanbak/everydaybak.rman' msglog=/opt/oracle/rmanbak/everydaybak_$

daytime.log");
</code></pre></div></div>

<p>è®¾ç½®crontab</p>

<p>æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œæ•°æ®åº“çš„å¤‡ä»½</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 1 * * * su - oracle -c /opt/oracle/rmanbak/backup.pl
</code></pre></div></div>

<h3 id="å®æˆ˜2">å®æˆ˜2</h3>

<p>1ã€å¤‡ä»½æ•´ä¸ªæ•°æ®åº“ï¼ŒåŒ…æ‹¬æ§åˆ¶æ–‡ä»¶ä»¥åŠå½’æ¡£æ—¥å¿—ï¼›</p>

<p>2ã€æ¸…é™¤3å¤©å‰å¤‡ä»½çš„å½’æ¡£æ—¥å¿—ã€‚</p>

<p>RMANè„šæœ¬</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oracle@mmsc103:~/rmanbak&gt; more everydaybak.rman

#script.:fullbakup.rman

# creater:wangyunzeng

# date:2011-03-11

# desc:backup all database datafile in archive with rman

# connect database

connect target rman/rman;

connect catalogrman/rman@mmsgdb;

#start backup database

run

{

 allocate channel t1 type disk; 

configure controlfile autobackup format for device type disk to '/opt/oracle/rmanbak/controlfile_bak_%F';            

backup database format 'fullbak_%s_%p_%u'  (archivelog all );

crosscheck backupset;

delete noprompt obsolete;

delete noprompt archivelog until time "sysdate -3";

release channel t1;     

}

#end
</code></pre></div></div>

<h2 id="rmanå¸¸è§é—®é¢˜è§£å†³æ–¹æ³•">RMANå¸¸è§é—®é¢˜è§£å†³æ–¹æ³•</h2>

<h3 id="rmanå‘½ä»¤è¾“å…¥åç»ˆç«¯æ— ååº”ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ä¸”é•¿æ—¶é—´å¦‚æ­¤">RMANå‘½ä»¤è¾“å…¥åç»ˆç«¯æ— ååº”ï¼Œä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼Œä¸”é•¿æ—¶é—´å¦‚æ­¤</h3>

<p>åŸå› ï¼šæ“ä½œç³»ç»Ÿä¹Ÿæœ‰ä¸€ä¸ªrmanå‘½ä»¤ï¼Œè¿™é‡Œæ‰§è¡Œçš„æ˜¯osçš„rmanè€ŒéOracleçš„</p>

<p>è§£å†³ï¼šoracleç”¨æˆ·è®¾ç½®ç¯å¢ƒå˜é‡ export PATH=$ORACLE_HOME:$PATH</p>

<h3 id="rmanæ— æ³•è¿›è¡Œå¤‡ä»½æ“ä½œæŸ¥çœ‹å¤‡ä»½ä¿¡æ¯é…ç½®ä¿¡æ¯">RMANæ— æ³•è¿›è¡Œå¤‡ä»½æ“ä½œ/æŸ¥çœ‹å¤‡ä»½ä¿¡æ¯/é…ç½®ä¿¡æ¯</h3>

<p>RMAN-03002: list å‘½ä»¤ (åœ¨ 03/05/2011 09:28:03 ä¸Š) å¤±è´¥</p>

<p>RMAN-06004: æ¢å¤ç›®å½•æ•°æ®åº“å‘ç”Ÿ ORACLE é”™è¯¯: RMAN-20001: target database not found in recovery catalog</p>

<p>RMAN-03002: backup å‘½ä»¤ (åœ¨ 03/05/2011 09:28:32 ä¸Š) å¤±è´¥</p>

<p>RMAN-03014: æ¢å¤ç›®å½•çš„éšå¼é‡æ–°åŒæ­¥å¤±è´¥</p>

<p>RMAN-06004: æ¢å¤ç›®å½•æ•°æ®åº“å‘ç”Ÿ ORACLE é”™è¯¯: RMAN-20001: åœ¨æ¢å¤ç›®å½•ä¸­æœªæ‰¾åˆ°ç›®æ ‡æ•°æ®åº“</p>

<p>åŸå› ï¼šRMANæœªæ³¨å†Œã€‚</p>

<p>è§£å†³æ–¹æ³•ï¼šæ³¨å†ŒRMANã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMAN&gt; register database;           
</code></pre></div></div>

<p>â€‹</p>

<h3 id="rmanå¤‡ä»½æ–‡ä»¶å¼‚å¸¸åˆ é™¤">RMANå¤‡ä»½æ–‡ä»¶å¼‚å¸¸åˆ é™¤</h3>

<p>åŸå› ï¼šRMANå¤‡ä»½çš„æ–‡ä»¶å­˜æ”¾åœ¨æŸä¸ªç›®å½•ä¸‹ï¼Œè¯¥æ–‡ä»¶æ²¡æœ‰é€šè¿‡rmanå‘½ä»¤deleteåˆ é™¤ï¼Œè€Œæ˜¯åœ¨æ“ä½œç³»ç»Ÿä¾§æ‰§è¡Œrmæ“ä½œï¼Œå¯¼è‡´å†å»åˆ é™¤è¿™ä¸ªå¤‡ä»½æ–‡ä»¶æ—¶æ— æ³•åˆ é™¤æ‰ã€‚</p>

<p>è§£å†³ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMAN&gt; list backupset by backup summary;

RMAN&gt; crosscheck backupset;

RMAN&gt; delete backupset;
</code></pre></div></div>
:ET