<h1 id="概述">概述</h1>

<p>Ubuntu16.04，产品新增了Elasticsearch功能，在测试ES服务启用过程冲，选择240G 的Intel S4510 型号的SSD一块作为ES的data：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Model Family:     Intel S4510/S4610/S4500/S4600 Series SSDs
Device Model:     INTEL SSDSC2KG240G8
</code></pre></div></div>

<p>在频繁测试ES服务启&amp;停过程中，发现有个node上的众多服务接收到终止信号(15),而且复现几率非常的高,此时ipmi console出现如下信息：</p>

<p><img class="shadow" src="/img/in-post/emergency_mode.png" width="1200" /></p>

<p>执行systemctl --failed，信息如下：</p>

<p><img class="shadow" src="/img/in-post/systemctl_failed.png" width="1200" /></p>

<p>使用 ‘journalctl -xb’，dump的信息中，未找到问题发生的原因，只有类似如下的片断信息：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Jun 19 18:20:17 node76 kernel: ata2.00: Enabling discard_zeroes_data
Jun 19 18:20:17 node76 multipath[829224]: sdf: using deprecated getuid callout
Jun 19 18:20:18 node76 kernel: ata2.00: Enabling discard_zeroes_data
Jun 19 18:20:18 node76 kernel:  sdf: sdf1
Jun 19 18:20:18 node76 multipath[829250]: sdf: using deprecated getuid callout
Jun 19 18:20:19 node76 multipath[829286]: sdf: using deprecated getuid callout
Jun 19 18:20:19 node76 sshd[829305]: Accepted publickey for root from 10.10.10.75 port 53688 ssh2: RSA SHA256:5/ngrgVfOOOLNuPyS1dflwHrc/sN9BSgDxNHVmJA0UE
Jun 19 18:20:19 node76 sshd[829305]: pam_unix(sshd:session): session opened for user root by (uid=0)
Jun 19 18:20:19 node76 systemd-logind[1841]: New session 3065 of user root.
-- Subject: A new session 3065 has been created for user root
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- Documentation: http://www.freedesktop.org/wiki/Software/systemd/multiseat
--
-- A new session with the ID 3065 has been created for the user root.
--
-- The leading process of the session is 829305.
Jun 19 18:20:19 node76 systemd[1]: Started Session 3065 of user root.
-- Subject: Unit session-3065.scope has finished start-up
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
-- Unit session-3065.scope has finished starting up.
--
-- The start-up result is done.
Jun 19 18:20:19 node76 multipath[829322]: sdf: using deprecated getuid callout
Jun 19 18:20:19 node76 sshd[829305]: Received disconnect from 10.10.10.75 port 53688:11: disconnected by user
Jun 19 18:20:19 node76 sshd[829305]: Disconnected from 10.10.10.75 port 53688
Jun 19 18:20:19 node76 sshd[829305]: pam_unix(sshd:session): session closed for user root
Jun 19 18:20:19 node76 systemd-logind[1841]: Removed session 3065.
-- Subject: Session 3065 has been terminated
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- Documentation: http://www.freedesktop.org/wiki/Software/systemd/multiseat
--
-- A session with the ID 3065 has been terminated.
Jun 19 18:20:19 node76 kernel: ata2.00: Enabling discard_zeroes_data
Jun 19 18:20:19 node76 sshd[829336]: Accepted publickey for root from 10.10.10.75 port 53694 ssh2: RSA SHA256:5/ngrgVfOOOLNuPyS1dflwHrc/sN9BSgDxNHVmJA0UE
Jun 19 18:20:19 node76 sshd[829336]: pam_unix(sshd:session): session opened for user root by (uid=0)
Jun 19 18:20:19 node76 kernel:  sdf: sdf1
Jun 19 18:20:19 node76 systemd-logind[1841]: New session 3066 of user root.
-- Subject: A new session 3066 has been created for user root
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- Documentation: http://www.freedesktop.org/wiki/Software/systemd/multiseat
--
-- A new session with the ID 3066 has been created for the user root.
--
-- The leading process of the session is 829336.
Jun 19 18:20:19 node76 systemd[1]: Started Session 3066 of user root.
-- Subject: Unit session-3066.scope has finished start-up
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
-- Unit session-3066.scope has finished starting up.
--
-- The start-up result is done.
Jun 19 18:20:19 node76 multipath[829356]: sdf: using deprecated getuid callout
Jun 19 18:20:19 node76 sshd[829336]: Received disconnect from 10.10.10.75 port 53694:11: disconnected by user
Jun 19 18:20:19 node76 sshd[829336]: Disconnected from 10.10.10.75 port 53694
Jun 19 18:20:19 node76 sshd[829336]: pam_unix(sshd:session): session closed for user root
Jun 19 18:20:19 node76 systemd-logind[1841]: Removed session 3066.
-- Subject: Session 3066 has been terminated
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- Documentation: http://www.freedesktop.org/wiki/Software/systemd/multiseat
--
-- A session with the ID 3066 has been terminated.
Jun 19 18:20:20 node76 sshd[829382]: Accepted publickey for root from 10.10.10.75 port 53696 ssh2: RSA SHA256:5/ngrgVfOOOLNuPyS1dflwHrc/sN9BSgDxNHVmJA0UE
Jun 19 18:20:20 node76 sshd[829382]: pam_unix(sshd:session): session opened for user root by (uid=0)
Jun 19 18:20:20 node76 systemd-logind[1841]: New session 3067 of user root.
-- Subject: A new session 3067 has been created for user root
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- Documentation: http://www.freedesktop.org/wiki/Software/systemd/multiseat
--
-- A new session with the ID 3067 has been created for the user root.
--
-- The leading process of the session is 829382.
Jun 19 18:20:20 node76 systemd[1]: Started Session 3067 of user root.
-- Subject: Unit session-3067.scope has finished start-up
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
-- Unit session-3067.scope has finished starting up.
--
-- The start-up result is done.
Jun 19 18:20:20 node76 sshd[829382]: Received disconnect from 10.10.10.75 port 53696:11: disconnected by user
Jun 19 18:20:20 node76 sshd[829382]: Disconnected from 10.10.10.75 port 53696
Jun 19 18:20:20 node76 sshd[829382]: pam_unix(sshd:session): session closed for user root
Jun 19 18:20:20 node76 systemd-logind[1841]: Removed session 3067.
-- Subject: Session 3067 has been terminated
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- Documentation: http://www.freedesktop.org/wiki/Software/systemd/multiseat
--
-- A session with the ID 3067 has been terminated.
Jun 19 18:20:20 node76 sshd[829415]: Accepted publickey for root from 10.10.10.75 port 53702 ssh2: RSA SHA256:5/ngrgVfOOOLNuPyS1dflwHrc/sN9BSgDxNHVmJA0UE
Jun 19 18:20:20 node76 sshd[829415]: pam_unix(sshd:session): session opened for user root by (uid=0)
Jun 19 18:20:20 node76 systemd-logind[1841]: New session 3068 of user root.
-- Subject: A new session 3068 has been created for user root
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- Documentation: http://www.freedesktop.org/wiki/Software/systemd/multiseat
--
-- A new session with the ID 3068 has been created for the user root.
--
-- The leading process of the session is 829415.
Jun 19 18:20:20 node76 systemd[1]: Started Session 3068 of user root.
-- Subject: Unit session-3068.scope has finished start-up
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
-- Unit session-3068.scope has finished starting up.
--
-- The start-up result is done.
Jun 19 18:20:20 node76 kernel: ata2.00: Enabling discard_zeroes_data
Jun 19 18:20:20 node76 kernel:  sdf: sdf1
Jun 19 18:20:20 node76 kernel: ata2.00: Enabling discard_zeroes_data
Jun 19 18:20:20 node76 kernel:  sdf:
Jun 19 18:20:20 node76 multipath[829431]: sdf: using deprecated getuid callout
Jun 19 18:20:20 node76 sshd[829415]: Received disconnect from 10.10.10.75 port 53702:11: disconnected by user
Jun 19 18:20:20 node76 sshd[829415]: Disconnected from 10.10.10.75 port 53702
Jun 19 18:20:20 node76 sshd[829415]: pam_unix(sshd:session): session closed for user root
Jun 19 18:20:20 node76 systemd-logind[1841]: Removed session 3068.
-- Subject: Session 3068 has been terminated
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- Documentation: http://www.freedesktop.org/wiki/Software/systemd/multiseat
--
-- A session with the ID 3068 has been terminated.
Jun 19 18:20:21 node76 systemd-udevd[829425]: inotify_add_watch(9, /dev/sdf1, 10) failed: No such file or directory
Jun 19 18:20:21 node76 multipath[829479]: sdf: using deprecated getuid callout
Jun 19 18:20:21 node76 multipath[829507]: sdf: using deprecated getuid callout
Jun 19 18:20:21 node76 kernel: ata2.00: Enabling discard_zeroes_data
Jun 19 18:20:21 node76 kernel:  sdf:
Jun 19 18:20:21 node76 multipath[829550]: sdf: using deprecated getuid callout
Jun 19 18:20:22 node76 kernel: ata2.00: Enabling discard_zeroes_data
Jun 19 18:20:22 node76 kernel:  sdf:
Jun 19 18:20:22 node76 multipath[829590]: sdf: using deprecated getuid callout
Jun 19 18:20:22 node76 multipath[829616]: sdf: using deprecated getuid callout
Jun 19 18:20:23 node76 kernel: ata2.00: Enabling discard_zeroes_data
Jun 19 18:20:23 node76 kernel: ata2.00: Enabling discard_zeroes_data
Jun 19 18:20:23 node76 kernel: ata2.00: Enabling discard_zeroes_data
Jun 19 18:20:23 node76 multipath[829658]: sdf: using deprecated getuid callout
Jun 19 18:20:23 node76 multipath[829685]: sdf: using deprecated getuid callout

..............................此处省略一部分信息......................................

Jun 19 18:22:48 node76 systemd[1]: Started Session 3077 of user root.
-- Subject: Unit session-3077.scope has finished start-up
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
-- Unit session-3077.scope has finished starting up.
--
-- The start-up result is done.
Jun 19 18:22:59 node76 sshd[844776]: Accepted publickey for root from 10.16.172.75 port 41614 ssh2: RSA SHA256:5/ngrgVfOOOLNuPyS1dflwHrc/sN9BSgDxNHVmJA0UE
Jun 19 18:22:59 node76 sshd[844776]: pam_unix(sshd:session): session opened for user root by (uid=0)
Jun 19 18:22:59 node76 systemd-logind[1841]: New session 3078 of user root.
-- Subject: A new session 3078 has been created for user root
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- Documentation: http://www.freedesktop.org/wiki/Software/systemd/multiseat
--
-- A new session with the ID 3078 has been created for the user root.
--
-- The leading process of the session is 844776.
Jun 19 18:22:59 node76 systemd[1]: Started Session 3078 of user root.
-- Subject: Unit session-3078.scope has finished start-up
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
-- Unit session-3078.scope has finished starting up.
--
-- The start-up result is done.
Jun 19 18:22:59 node76 radosgw[793492]: 2020-06-19 18:22:59.685447 7f3df412b700 -1 received  signal: Terminated from  PID: 1 task name: /sbin/init  UID: 0
Jun 19 18:22:59 node76 radosgw[793492]: 2020-06-19 18:22:59.685486 7f3e336e4040 -1 shutting down
Jun 19 18:22:59 node76 systemd[1]: Stopping Ceph rados gateway...
-- Subject: Unit ceph-radosgw@radosgw.0.service has begun shutting down
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
</code></pre></div></div>

<p>重新开机启动后，syslog日志片断如下:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Jun 18 18:19:35 node75 kernel: [174076.635228] ata2.00: Enabling discard_zeroes_data
Jun 18 18:19:35 node75 kernel: [174076.639312]  sdf:
Jun 18 18:19:35 node75 multipath: sdf: using deprecated getuid callout
Jun 18 18:19:35 node75 ntpd[3446]: Listen normally on 68 bond0 10.16.172.79:123
Jun 18 18:19:35 node75 ntpd[3446]: Listen normally on 69 bond0 10.16.172.80:123
Jun 18 18:19:35 node75 ntpd[3446]: new interface(s) found: waking up resolver
Jun 18 18:19:35 node75 systemd-udevd[149835]: inotify_add_watch(9, /dev/sdf1, 10) failed: No such file or directory
Jun 18 18:19:35 node75 systemd[1]: Mounting /opt/datasearch/0...
Jun 18 18:19:35 node75 mount[149927]: mount: special device /dev/disk/by-partlabel/datasearch0 does not exist
Jun 18 18:19:35 node75 systemd[1]: opt-datasearch-0.mount: Mount process exited, code=exited status=32
Jun 18 18:19:35 node75 systemd[1]: Failed to mount /opt/datasearch/0.
Jun 18 18:19:35 node75 systemd[1]: opt-datasearch-0.mount: Unit entered failed state.
Jun 18 18:19:35 node75 multipath: sdf: using deprecated getuid callout
Jun 18 18:19:36 node75 kernel: [174077.640278] ata2.00: Enabling discard_zeroes_data
Jun 18 18:19:36 node75 kernel: [174077.642668]  sdf:
Jun 18 18:19:37 node75 kernel: [174078.789459] ata2.00: Enabling discard_zeroes_data
Jun 18 18:19:37 node75 kernel: [174078.794294] ata2.00: Enabling discard_zeroes_data
Jun 18 18:19:37 node75 kernel: [174078.800320] ata2.00: Enabling discard_zeroes_data
Jun 18 18:19:38 node75 kernel: [174079.491352] ata2.00: Enabling discard_zeroes_data
Jun 18 18:19:38 node75 multipath: message repeated 5 times: [ sdf: using deprecated getuid callout]
Jun 18 18:19:40 node75 systemd[1]: Stopping ezs3 bucket logging agent service...
Jun 18 18:19:44 node75 systemd[1]: Stopped ezs3 bucket logging agent service.
Jun 18 18:19:44 node75 systemd[1]: Reloading.
Jun 18 18:19:44 node75 systemd[1]: Reloading.
Jun 18 18:19:44 node75 systemd[1]: Started ACPI event daemon.
Jun 18 18:19:44 node75 systemd[1]: Stopping Ceph rados gateway...
Jun 18 18:19:44 node75 radosgw[138955]: 2020-06-18 18:19:44.455571 7f349a88c700 -1 received  signal: Terminated from  PID: 1 task name: /sbin/init  UID: 0
Jun 18 18:19:44 node75 radosgw[138955]: 2020-06-18 18:19:44.455636 7f34d9e45040 -1 shutting down
Jun 18 18:19:44 node75 systemd[1]: Stopped Ceph rados gateway.
Jun 18 18:19:44 node75 systemd[1]: Reloading.
Jun 18 18:19:44 node75 systemd[1]: Reloading.
Jun 18 18:19:44 node75 systemd[1]: Started ACPI event daemon.
Jun 18 18:19:45 node75 radosgw[131963]: 2020-06-18 18:19:45.107577 7fcfdfa6a700 -1 received  signal: Terminated from  PID: 1 task name: /sbin/init  UID: 0
Jun 18 18:19:45 node75 radosgw[131963]: 2020-06-18 18:19:45.107620 7fd01f023040 -1 shutting down
Jun 18 18:19:45 node75 systemd[1]: Stopping Ceph rados gateway...
Jun 18 18:19:45 node75 systemd[1]: Stopped Ceph rados gateway.
Jun 18 18:19:45 node75 systemd[1]: Started Ceph rados gateway.
Jun 18 18:19:45 node75 systemd[1]: Reloading.
Jun 18 18:19:45 node75 systemd[1]: Reloading.
Jun 18 18:19:45 node75 systemd[1]: Started ACPI event daemon.
Jun 18 18:19:45 node75 systemd[1]: Stopped ezs3 bucket logging agent service.
Jun 18 18:19:45 node75 systemd[1]: Starting ezs3 bucket logging agent service...
Jun 18 18:19:45 node75 systemd[1]: Stopped ezs3 bucket logging agent service.
Jun 18 18:19:45 node75 systemd[1]: Starting ezs3 bucket logging agent service...
Jun 18 18:19:46 node75 systemd[1]: ezs3-bucket-logging-agent.service: Supervising process 152415 which is not our child. We'll most likely not notice when it exits.
Jun 18 18:19:46 node75 systemd[1]: Started ezs3 bucket logging agent service.
Jun 18 18:19:46 node75 systemd[1]: Reloading.
Jun 18 18:19:46 node75 systemd[1]: Reloading.
Jun 18 18:19:47 node75 systemd[1]: Started ACPI event daemon.
Jun 18 18:19:53 node75 Keepalived[149387]: Stopping
Jun 18 18:19:53 node75 Keepalived_vrrp[149388]: (VRRP0) sent 0 priority
Jun 18 18:19:53 node75 systemd[1]: Stopping Keepalive Daemon (LVS and VRRP)...
Jun 18 18:19:53 node75 avahi-daemon[1704]: Withdrawing address record for 10.16.172.80 on bond0.
Jun 18 18:19:53 node75 avahi-daemon[1704]: Withdrawing address record for 10.16.172.79 on bond0.
Jun 18 18:19:53 node75 Keepalived_vrrp[149388]: (DATASEARCH) sent 0 priority
Jun 18 18:19:54 node75 Keepalived_vrrp[149388]: Stopped
Jun 18 18:19:54 node75 Keepalived[149387]: Stopped Keepalived v2.0.10 (09/19,2019), git commit 6.0-rc1-9509-gb73d9e153
Jun 18 18:19:54 node75 systemd[1]: Stopped Keepalive Daemon (LVS and VRRP).
Jun 18 18:19:54 node75 systemd[1]: Started Keepalive Daemon (LVS and VRRP).
Jun 18 18:19:54 node75 Keepalived[154125]: Starting Keepalived v2.0.10 (09/19,2019), git commit 6.0-rc1-9509-gb73d9e153
Jun 18 18:19:54 node75 Keepalived[154125]: Running on Linux 4.14.148-server #1 SMP Thu Jun 11 18:49:19 CST 2020 (built for Linux 4.4.176)
Jun 18 18:19:54 node75 Keepalived[154125]: Command line: '/usr/sbin/keepalived' '--dont-fork'
Jun 18 18:19:54 node75 Keepalived[154125]: Opening file '/etc/keepalived/keepalived.conf'.
Jun 18 18:19:54 node75 Keepalived[154125]: Starting VRRP child process, pid=154126
Jun 18 18:19:54 node75 Keepalived_vrrp[154126]: Registering Kernel netlink reflector
Jun 18 18:19:54 node75 Keepalived_vrrp[154126]: Registering Kernel netlink command channel
Jun 18 18:19:54 node75 Keepalived_vrrp[154126]: Opening file '/etc/keepalived/keepalived.conf'.
Jun 18 18:19:54 node75 Keepalived_vrrp[154126]: Registering gratuitous ARP shared channel
Jun 18 18:19:54 node75 Keepalived_vrrp[154126]: (VRRP0) Entering BACKUP STATE (init)
Jun 18 18:19:55 node75 ntpd[3446]: Deleting interface #68 bond0, 10.16.172.79#123, interface stats: received=0, sent=0, dropped=0, active_time=20 secs
Jun 18 18:19:55 node75 ntpd[3446]: Deleting interface #69 bond0, 10.16.172.80#123, interface stats: received=0, sent=0, dropped=0, active_time=20 secs
Jun 18 18:19:56 node75 Keepalived_vrrp[154126]: (VRRP0) Entering MASTER STATE
Jun 18 18:19:56 node75 Keepalived_vrrp[154126]: (VRRP0) using locally configured advertisement interval (400 milli-sec)
Jun 18 18:19:56 node75 avahi-daemon[1704]: Registering new address record for 10.16.172.79 on bond0.IPv4.
Jun 18 18:19:57 node75 ntpd[3446]: Listen normally on 70 bond0 10.16.172.79:123
Jun 18 18:19:57 node75 ntpd[3446]: new interface(s) found: waking up resolver
Jun 18 18:20:01 node75 CRON[154717]: (root) CMD (bash /usr/local/bin/monitor_ctdb.sh &gt;/dev/null 2&gt;&amp;1)
Jun 18 18:21:49 node75 systemd[1]: Started Session 3232 of user root.
Jun 18 18:22:01 node75 CRON[165327]: (root) CMD (bash /usr/local/bin/monitor_ctdb.sh &gt;/dev/null 2&gt;&amp;1)
Jun 18 18:22:03 node75 systemd[1]: Stopping ezrpc service...
Jun 18 18:22:04 node75 systemd[1]: Started Session 3234 of user root.
Jun 18 18:22:05 node75 systemd[1]: Stopped ezrpc service.
Jun 18 18:22:05 node75 systemd[1]: Starting ezrpc service...
Jun 18 18:22:05 node75 systemd[1]: Started Session 3235 of user root.
Jun 18 18:22:05 node75 systemd[1]: Started Session 3236 of user root.
Jun 18 18:22:05 node75 systemd[1]: ezrpc.service: Supervising process 165656 which is not our child. We'll most likely not notice when it exits.
Jun 18 18:22:05 node75 systemd[1]: Started ezrpc service.
Jun 18 18:22:06 node75 systemd[1]: Started Session 3237 of user root.
Jun 18 18:22:07 node75 systemd[1]: Started Session 3238 of user root.
Jun 18 18:22:09 node75 systemd[1]: Started Session 3239 of user root.
Jun 18 18:22:10 node75 systemd[1]: Started Session 3240 of user root.
Jun 18 18:22:10 node75 systemd[1]: Started Session 3241 of user root.
Jun 18 18:22:10 node75 systemd[1]: Started Session 3242 of user root.
Jun 18 18:22:10 node75 systemd[1]: Started Session 3243 of user root.
Jun 18 18:22:11 node75 systemd[1]: Started Session 3244 of user root.
Jun 18 18:22:11 node75 systemd[1]: Started Session 3245 of user root.
Jun 18 18:22:13 node75 systemd[1]: Started Session 3246 of user root.
Jun 18 18:22:14 node75 systemd[1]: Started Session 3247 of user root.
Jun 18 18:22:17 node75 systemd[1]: Started Session 3248 of user root.
Jun 18 18:22:22 node75 kernel: [174244.149039] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:22 node75 multipath: sdf: using deprecated getuid callout
Jun 18 18:22:23 node75 kernel: [174245.160084] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:23 node75 kernel: [174245.163924]  sdf:
Jun 18 18:22:24 node75 kernel: [174246.313987] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:24 node75 kernel: [174246.320486] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:24 node75 kernel: [174246.326831] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:25 node75 kernel: [174247.217690] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:26 node75 kernel: [174247.496059] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:27 node75 kernel: [174248.504647] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:27 node75 kernel: [174248.512515]  sdf:
Jun 18 18:22:27 node75 multipath: message repeated 8 times: [ sdf: using deprecated getuid callout]
Jun 18 18:22:28 node75 kernel: [174249.667311] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:28 node75 kernel: [174249.673618] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:28 node75 systemd[1]: Started Session 3258 of user root.
Jun 18 18:22:28 node75 multipath: sdf: using deprecated getuid callout
Jun 18 18:22:29 node75 kernel: [174250.362596] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:30 node75 kernel: [174251.374819] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:30 node75 kernel: [174251.379011]  sdf: sdf1
Jun 18 18:22:30 node75 kernel: [174252.064736] ata2.00: Enabling discard_zeroes_data
Jun 18 18:22:30 node75 kernel: [174252.069092]  sdf: sdf1
Jun 18 18:22:30 node75 multipath: message repeated 5 times: [ sdf: using deprecated getuid callout]
Jun 18 18:22:34 node75 systemd[1]: Started Session 3259 of user root.
Jun 18 18:22:34 node75 systemd[1]: Started Session 3260 of user root.
Jun 18 18:22:35 node75 systemd[1]: Started Session 3261 of user root.
Jun 18 18:22:37 node75 kernel: [174258.563000] EXT4-fs (sdf1): mounted filesystem with ordered data mode. Opts: (null)
Jun 18 18:22:37 node75 systemd[1]: Failed to set up mount unit: Device or resource busy
Jun 18 18:22:37 node75 systemd[1]: Reloading.
Jun 18 18:22:37 node75 systemd[1]: Started ACPI event daemon.
Jun 18 18:22:37 node75 systemd[1]: Reloading.
Jun 18 18:22:38 node75 systemd[1]: Started ACPI event daemon.
Jun 18 18:22:38 node75 systemd[1]: Reloading.
Jun 18 18:22:38 node75 systemd[1]: Started ACPI event daemon.
Jun 18 18:22:38 node75 systemd[1]: Starting Elasticsearch...
Jun 18 18:22:38 node75 elasticsearch[169315]: OpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.
Jun 18 18:22:42 node75 systemd[1]: Started Session 3262 of user root.
Jun 18 18:22:49 node75 systemd[1]: Started Session 3263 of user root.
Jun 18 18:22:50 node75 systemd[1]: Started Session 3264 of user root.
Jun 18 18:22:51 node75 systemd[1]: Started Session 3265 of user root.
Jun 18 18:22:51 node75 systemd[1]: Started Elasticsearch.
Jun 18 18:22:52 node75 elasticsearch[169315]: loading dict /usr/share/elasticsearch/plugins/jieba/dic/user.dict
Jun 18 18:22:52 node75 elasticsearch[169315]: loading dict /usr/share/elasticsearch/plugins/jieba/dic/sougou.dict
Jun 18 18:22:53 node75 systemd[1]: Started Session 3266 of user root
</code></pre></div></div>

<p>说明一下：</p>

<p>上文中的sdf这个分区，是启用ES时选择的ES DATA disk,为了能够复现这个问题，写了支script指定循环次数去启用，停用ES 服务，并检查对应的挂载点，ES集群健康状态，ceph集群健康状态（因为出现shutdown ceph核心服务进行，ceph集群不健康作为退出条件）.</p>

<h1 id="问题复现使用的python脚本">问题复现使用的python脚本</h1>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# -*- coding:UTF-8 -*-
</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="nb">ConnectionError</span>
<span class="kn">from</span> <span class="nn">requests.packages.urllib3.exceptions</span> <span class="kn">import</span> <span class="n">InsecureRequestWarning</span>
<span class="n">requests</span><span class="p">.</span><span class="n">packages</span><span class="p">.</span><span class="n">urllib3</span><span class="p">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">login_session</span><span class="p">(</span><span class="n">public_ip</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s">"https://{}:8080/auth"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">public_ip</span><span class="p">)</span>
    <span class="n">login_data</span> <span class="o">=</span> <span class="p">{</span><span class="s">"user_id"</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s">"password"</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>

    <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">session</span><span class="p">()</span>
    <span class="n">session</span><span class="p">.</span><span class="n">keep_alive</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">session</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">update</span><span class="p">({</span><span class="s">'Accept'</span><span class="p">:</span> <span class="s">'application/json, text/javascript, */*; q=0.01'</span><span class="p">})</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="s">"POST"</span><span class="p">,</span> <span class="n">login_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">login_data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[ERROR]    Login web error, http status code is {} </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">))</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">session</span>


<span class="k">def</span> <span class="nf">http_request</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">http_method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">public_ip</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">params</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">data</span>

    <span class="c1"># set SSL Verify to False
</span>    <span class="n">session</span><span class="p">.</span><span class="n">verify</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1"># Set session keep alive to False
</span>    <span class="n">session</span><span class="p">.</span><span class="n">keep_alive</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="s">"cgi-bin"</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="c1"># Legacy CGI
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="n">http_method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="n">http_method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">login_session</span><span class="p">(</span><span class="n">public_ip</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="n">http_method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Restful CGI
</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="n">http_method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">login_session</span><span class="p">(</span><span class="n">public_ip</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="n">http_method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">500</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[ERROR]    Send HTTP request failed, backend return 500, internal server error </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>


<span class="k">def</span> <span class="nf">es_enable_data</span><span class="p">(</span><span class="n">public_ip</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">,</span> <span class="n">vip</span><span class="p">):</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"ip"</span><span class="p">:</span><span class="n">storage_ip</span><span class="p">,</span>
        <span class="s">"vip"</span><span class="p">:</span><span class="n">vip</span><span class="p">,</span>
        <span class="s">"router_id"</span><span class="p">:</span><span class="s">"80"</span><span class="p">,</span>
        <span class="s">"num_shards"</span><span class="p">:</span><span class="s">"6"</span><span class="p">,</span>
        <span class="s">"num_replicas"</span><span class="p">:</span><span class="s">"1"</span><span class="p">,</span>
        <span class="s">"storage_location"</span><span class="p">:</span><span class="s">"disk"</span><span class="p">,</span>
        <span class="s">"disks"</span><span class="p">:</span><span class="s">"[</span><span class="se">\"</span><span class="s">/dev/sdf</span><span class="se">\"</span><span class="s">]"</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">enable_es</span><span class="p">(</span><span class="n">public_ip</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">http_method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[{}] [Action]   Start to enable ES service on node : ({})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">))</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">http_request</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">http_method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="s">'return_code'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">progress_url</span> <span class="o">=</span> <span class="s">"https://{}:8080/cgi-bin/ezs3/json/elasticsearch_role_progress"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">public_ip</span><span class="p">)</span>
        <span class="n">check_progress</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">,</span> <span class="n">progress_url</span><span class="p">)</span>

        <span class="n">check_es_service_file</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">)</span>
        <span class="n">check_mount_point</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">)</span>
        <span class="n">check_fstab</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[ERROR]    Enable ES service failed, backend return : ({})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">))</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">es_disable_data</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'ip'</span><span class="p">:</span> <span class="n">storage_ip</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">disable_es</span><span class="p">(</span><span class="n">public_ip</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">http_method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[{}] [Action]   Disable ES service on node : ({})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">))</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">http_request</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">http_method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="s">'return_code'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">progress_url</span> <span class="o">=</span> <span class="s">"https://{}:8080/cgi-bin/ezs3/json/elasticsearch_role_progress"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">public_ip</span><span class="p">)</span>
        <span class="n">check_progress</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">,</span> <span class="n">progress_url</span><span class="p">,</span> <span class="n">enable_flag</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">check_fstab</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">,</span> <span class="n">enable_flag</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">check_mount_point</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">,</span> <span class="n">enable_flag</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">check_es_service_file</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">,</span> <span class="n">enable_flag</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[ERROR]    Disable ES service failed, backend return : ({})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">))</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">progress_params</span><span class="p">(</span><span class="n">storae_ip</span><span class="p">,</span> <span class="n">enable</span><span class="o">=</span><span class="s">'true'</span><span class="p">):</span>
    <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s">'ip'</span><span class="p">:</span> <span class="n">storae_ip</span><span class="p">,</span> <span class="s">'enable'</span><span class="p">:</span> <span class="n">enable</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">param</span>


<span class="k">def</span> <span class="nf">get_enable_progress</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">60</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">http_request</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="s">"GET"</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">param</span><span class="p">)</span> 
        <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s">'return_code'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">'response'</span><span class="p">][</span><span class="s">'info'</span><span class="p">][</span><span class="s">'progress'</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">progress</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">30</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">"                                 Wait for more than 150s, go on"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">58</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">"                                 ES progress is : ({})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">progress</span><span class="p">))</span>
                <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [ERROR]    Check ES progress failed, exit! </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">))</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_progress</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">enable_flag</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">enable_flag</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [Check]    Check ES enable progress on node : ({})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">))</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">progress_params</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [Check]    Check ES disable progress on node : ({})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">))</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">progress_params</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">,</span> <span class="n">enable</span><span class="o">=</span><span class="s">'false'</span><span class="p">)</span>

    <span class="n">get_enable_progress</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="n">param</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_radosgw_pid</span><span class="p">(</span><span class="n">hosts</span><span class="p">):</span>
    <span class="n">host_rgw_pid</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">each_host</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="s">"ssh {} ps aux | grep client.radosgw.0 | grep -v grep | awk '{{print $2}}'"</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
            <span class="n">host_rgw_pid</span><span class="p">[</span><span class="n">each_host</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [ERROR]    Not get radosgw pid on node :({})"</span><span class="p">.</span><span class="n">foramt</span><span class="p">(</span><span class="n">cur_time</span><span class="p">,</span> <span class="n">each_host</span><span class="p">))</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">host_rgw_pid</span>


<span class="k">def</span> <span class="nf">check_fstab</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">,</span> <span class="n">enable_flag</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [Check]    Check mount config in /etc/fstab on node : ({})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">))</span>

    <span class="n">fstab_content</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="s">"ssh {} 'cat /etc/fstab | grep datasearch'"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">)).</span><span class="n">read</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">enable_flag</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">"datasearch"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fstab_content</span><span class="p">:</span>
            <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [ERROR]    Enable ES, but not find mount point information in /etc/fstab </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">))</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">"datasearch"</span> <span class="ow">in</span> <span class="n">fstab_content</span><span class="p">:</span>
            <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [ERROR]    Disable ES, but still find mount point information in /etc/fstab </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">))</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_mount_point</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">,</span> <span class="n">enable_flag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">pre_check</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_check</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [Check]    Check mount point on node : ({})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">))</span>

    <span class="n">mount_info</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="s">"ssh {} 'mount | grep datasearch'"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">)).</span><span class="n">read</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">enable_flag</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mount_info</span><span class="p">:</span>
            <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [ERROR]    Enable ES, but not find mount point </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">))</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mount_info</span><span class="p">:</span>
            <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_check</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [ERROR]    Disable ES, but still find mount point </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [ERROR]    Precheck before enable ES, but still find mount point on node : ({}) </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">,</span> <span class="n">storage_ip</span><span class="p">))</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_es_service_file</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">,</span> <span class="n">enable_flag</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="s">"/etc/systemd/system/multi-user.target.wants/elasticsearch.service"</span>
    <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[{}] [Check]    Check {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">,</span> <span class="n">file_path</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">enable_flag</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [ERROR]  Enable ES, but not find ({}) </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">,</span> <span class="n">file_path</span><span class="p">))</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [ERROR]  Disable ES, but still find ({}) </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">,</span> <span class="n">file_path</span><span class="p">))</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_es_cluster_helath</span><span class="p">(</span><span class="n">public_ip</span><span class="p">):</span>
    <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[{}] [Check]    Check ES cluster status"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">))</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="s">"curl -s GET http://{}:9200/_cluster/health | json_pp | grep status"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">public_ip</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">es_health</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">'green'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">es_health</span><span class="p">:</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">29</span><span class="p">:</span>
                <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [ERROR]    ES Cluser helath status is : ({})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">,</span> <span class="n">es_health</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [ERROR]  Wait 60s, but ES cluser status is not 'green' </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">))</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_ceph_cluster_health</span><span class="p">():</span>
    <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[{}] [Check]    Check ceph cluster status"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">))</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="s">"ceph -s | grep health"</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">ceph_health</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">"HEALTH_OK"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ceph_health</span><span class="p">:</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [ERROR]  Wait 60s, but ceoh cluser status is not 'HEALTH_OK' </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">))</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">force_clean</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[Action]   Start to force to clean umount and disk on node : ({})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">))</span>

    <span class="n">umount_cmd</span> <span class="o">=</span> <span class="s">"ssh {} 'umount /opt/datasearch/0'"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">)</span>
    <span class="n">sgdisk_o</span> <span class="o">=</span> <span class="s">"ssh {} 'sgdisk -o /dev/sdf'"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">)</span>
    <span class="n">sgdisk_z</span> <span class="o">=</span> <span class="s">"ssh {} 'sgdisk -Z /dev/sdf'"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">)</span>
    <span class="n">ude</span> <span class="o">=</span> <span class="s">"ssh {} 'udevadm settle'"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">)</span>
    <span class="n">wip</span> <span class="o">=</span> <span class="s">" ssh {} 'wipefs -a -f /dev/sdf'"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">)</span>
    <span class="n">rm_folder</span> <span class="o">=</span> <span class="s">"ssh {} 'rm -rf /opt/datasearch/0/'"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">storage_ip</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="n">umount_cmd</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="n">sgdisk_o</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="n">sgdisk_z</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="n">ude</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="n">wip</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="n">rm_folder</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">loop_run</span><span class="p">(</span><span class="n">loop_times</span><span class="p">):</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s">"1"</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="s">"admin"</span>
    <span class="n">vip</span> <span class="o">=</span> <span class="s">"10.16.172.80/22"</span>
    <span class="n">public_ip</span> <span class="o">=</span> <span class="s">"10.16.172.75"</span>
    <span class="n">storage_ips</span> <span class="o">=</span> <span class="p">[</span><span class="s">"10.10.10.75"</span><span class="p">,</span> <span class="s">"10.10.10.76"</span><span class="p">,</span> <span class="s">"10.10.10.77"</span><span class="p">]</span>

    <span class="n">session</span> <span class="o">=</span> <span class="n">login_session</span><span class="p">(</span><span class="n">public_ip</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="n">enable_es_url</span> <span class="o">=</span> <span class="s">"https://{}:8080/cgi-bin/ezs3/json/elasticsearch_role_enable"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">public_ip</span><span class="p">)</span>
    <span class="n">disable_es_url</span> <span class="o">=</span> <span class="s">"https://{}:8080/cgi-bin/ezs3/json/elasticsearch_role_disable"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">public_ip</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">loop_times</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">---------------------------------------------- {} --------------------------------------------"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Before disable, check datasearch mount point again, because not known why the mount point mount again
</span>        <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">,</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[{}] [Check]    Precheck mount point on each node before enable ES service"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cur_time</span><span class="p">))</span>

        <span class="c1"># Only check once by the first time
</span>        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">each_storage_ip</span> <span class="ow">in</span> <span class="n">storage_ips</span><span class="p">:</span>
                <span class="n">check_mount_point</span><span class="p">(</span><span class="n">each_storage_ip</span><span class="p">,</span> <span class="n">enable_flag</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pre_check</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">each_storage_ip</span> <span class="ow">in</span> <span class="n">storage_ips</span><span class="p">:</span>
                    <span class="n">check_mount_point</span><span class="p">(</span><span class="n">each_storage_ip</span><span class="p">,</span> <span class="n">enable_flag</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pre_check</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># # Force clean
</span>        <span class="c1"># for each_storae_ip in storage_ips:
</span>        <span class="c1">#     force_clean(each_storae_ip)
</span>
        <span class="c1"># Enable ES service on all node
</span>        <span class="k">for</span> <span class="n">each_storage_ip</span> <span class="ow">in</span> <span class="n">storage_ips</span><span class="p">:</span>
            <span class="n">enable_es_data</span> <span class="o">=</span> <span class="n">es_enable_data</span><span class="p">(</span><span class="n">public_ip</span><span class="p">,</span> <span class="n">each_storage_ip</span><span class="p">,</span> <span class="n">vip</span><span class="p">)</span>
            <span class="n">enable_es</span><span class="p">(</span><span class="n">public_ip</span><span class="p">,</span> <span class="n">each_storage_ip</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="n">enable_es_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">enable_es_data</span><span class="p">)</span>

        <span class="c1"># Check ES cluser status
</span>        <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="s">"iptables -F"</span><span class="p">)</span>
        <span class="n">check_es_cluster_helath</span><span class="p">(</span><span class="n">public_ip</span><span class="p">)</span>

        <span class="c1"># Disable ES service on all node
</span>        <span class="k">for</span> <span class="n">each_storage_ip</span> <span class="ow">in</span> <span class="n">storage_ips</span><span class="p">:</span>
            <span class="n">disable_es_data</span> <span class="o">=</span> <span class="n">es_disable_data</span><span class="p">(</span><span class="n">each_storage_ip</span><span class="p">)</span> 
            <span class="n">disable_es</span><span class="p">(</span><span class="n">public_ip</span><span class="p">,</span> <span class="n">each_storage_ip</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="n">disable_es_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">disable_es_data</span><span class="p">)</span>


        <span class="c1"># Check ceph cluster status
</span>        <span class="n">check_ceph_cluster_health</span><span class="p">()</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># # Force clean
</span>        <span class="c1"># for each_storae_ip in storage_ips:
</span>        <span class="c1">#     force_clean(each_storae_ip)
</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">loop_times</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">loop_times</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[ERROR]  loop_times must &gt;=1 </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">loop_run</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">loop_times</span><span class="p">))</span>
</code></pre></div></div>

<h1 id="执行效果">执行效果</h1>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@node75:~# python enable_disable_es.py 3

---------------------------------------------- 1 --------------------------------------------
[Action]   Start to force to clean umount and disk on node : (10.10.10.75)
umount: /opt/datasearch/0: mountpoint not found
[Action]   Start to force to clean umount and disk on node : (10.10.10.76)
umount: /opt/datasearch/0: mountpoint not found
[Action]   Start to force to clean umount and disk on node : (10.10.10.77)
umount: /opt/datasearch/0: mountpoint not found

[2020-06-19 14:17:39] [Action]   Start to enable ES service on node : (10.10.10.75)
[2020-06-19 14:17:40] [Check]    Check ES enable progress on node : (10.10.10.75)
[2020-06-19 14:19:41] [Check]    Check mount config in /etc/fstab on node : (10.10.10.75)
[2020-06-19 14:19:41] [Check]    Check mount point on node : (10.10.10.75)

[2020-06-19 14:19:41] [Action]   Start to enable ES service on node : (10.10.10.76)
[2020-06-19 14:19:41] [Check]    Check ES enable progress on node : (10.10.10.76)
[2020-06-19 14:20:22] [Check]    Check mount config in /etc/fstab on node : (10.10.10.76)
[2020-06-19 14:20:22] [Check]    Check mount point on node : (10.10.10.76)

[2020-06-19 14:20:22] [Action]   Start to enable ES service on node : (10.10.10.77)
[2020-06-19 14:20:22] [Check]    Check ES enable progress on node : (10.10.10.77)
[2020-06-19 14:20:58] [Check]    Check mount config in /etc/fstab on node : (10.10.10.77)
[2020-06-19 14:20:58] [Check]    Check mount point on node : (10.10.10.77)

[2020-06-19 14:20:58] [Check]    Check ES cluster status

[2020-06-19 14:21:04] [Action]   Disable ES service on node : (10.10.10.75)
[2020-06-19 14:21:04] [Check]    Check ES disable progress on node : (10.10.10.75)
[2020-06-19 14:21:14] [Check]    Check mount config in /etc/fstab on node : (10.10.10.75)
[2020-06-19 14:21:14] [Check]    Check mount point on node : (10.10.10.75)

[2020-06-19 14:21:14] [Action]   Disable ES service on node : (10.10.10.76)
[2020-06-19 14:21:14] [Check]    Check ES disable progress on node : (10.10.10.76)
[2020-06-19 14:21:24] [Check]    Check mount config in /etc/fstab on node : (10.10.10.76)
[2020-06-19 14:21:25] [Check]    Check mount point on node : (10.10.10.76)

[2020-06-19 14:21:25] [Action]   Disable ES service on node : (10.10.10.77)
[2020-06-19 14:21:25] [Check]    Check ES disable progress on node : (10.10.10.77)
[2020-06-19 14:21:50] [Check]    Check mount config in /etc/fstab on node : (10.10.10.77)
[2020-06-19 14:21:50] [Check]    Check mount point on node : (10.10.10.77)

[2020-06-19 14:21:51] [Check]    Check ceph cluster status
[Action]   Start to force to clean umount and disk on node : (10.10.10.75)
umount: /opt/datasearch/0: mountpoint not found
[Action]   Start to force to clean umount and disk on node : (10.10.10.76)
umount: /opt/datasearch/0: mountpoint not found
[Action]   Start to force to clean umount and disk on node : (10.10.10.77)
umount: /opt/datasearch/0: mountpoint not found

---------------------------------------------- 2 --------------------------------------------
[Action]   Start to force to clean umount and disk on node : (10.10.10.75)
umount: /opt/datasearch/0: mountpoint not found
[Action]   Start to force to clean umount and disk on node : (10.10.10.76)
umount: /opt/datasearch/0: mountpoint not found
[Action]   Start to force to clean umount and disk on node : (10.10.10.77)
umount: /opt/datasearch/0: mountpoint not found

[2020-06-19 14:22:13] [Action]   Start to enable ES service on node : (10.10.10.75)
[2020-06-19 14:22:14] [Check]    Check ES enable progress on node : (10.10.10.75)
                                 Wait for more than 150s, go on
                                 ES progress is : (30)
                                 ES progress is : (30)
[2020-06-19 14:27:16] [ERROR]    Check ES progress failed, exit! 

root@node75:~#
</code></pre></div></div>

<h1 id="为何会出现-local-fstarget-failed-with-result-dependency">为何会出现 ‘local-fs.target failed with result dependency’</h1>

<p>这篇文章： <code class="highlighter-rouge">https://unix.stackexchange.com/questions/416640/how-to-disable-systemd-agressive-emergency-shell-behaviour</code></p>

<p>有提及到:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>If you search through the unit files, there are only a very few ways for the boot to fall back to emergency.target. It's usually when a .mount unit for a local filesystem fails, causing local-fs.target to fail. Or when your initramfs fails to mount the root filesystem, if your initramfs uses systemd.

local-fs.target has OnFailure=emergency.target. And it gets failed because units for local filesystems are automatically added to the Requires list of local-fs.target (unless they have DefaultDependencies=no).
</code></pre></div></div>

<p>没有尝试去修改 <code class="highlighter-rouge">/lib/systemd/system/local-fs.target</code> 中 <code class="highlighter-rouge">OnFailure=</code> 为空(此文件中DefaultDependencies=no)，也没有新增<code class="highlighter-rouge">/etc/systemd/system/local-fs.target.d/nofail.conf</code>文件单独去设置<code class="highlighter-rouge">OnFailure=</code>` 为空。</p>

<h1 id="解决方法">解决方法</h1>

<p>由于担心修改<code class="highlighter-rouge">local-fs.target</code>会带来额外影响，这里没有采用修改<code class="highlighter-rouge">OnFailure=</code> 为空的方法，具体处理方法如下：</p>

<p>使用systemctl show查看local-fs.target requires</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@node76:/var/log# systemctl show --property Requires local-fs.target
Requires=-.mount opt-datasearch-0.mount
root@node76:/var/log#
</code></pre></div></div>

<p>这里有个opt-datasearch-0.mount，而这个正好是ES data所对应的挂载点信息，说明启停ES服务时动了/etc/fstab文件了，新增或删除了/etc/fsta对应的ES挂载点信息了，依照这个思路，调整一下产品修改/etc/fstab时间点，在停用ES时，最先去修改/etc/fstab文件，然后才去执行清理zone-group、umount、formate disk，disable es等等动作，然后使用上述脚本验证了30次，问题没有再次浮现。而在调整前，几次就会复现。</p>

<h1 id="推论">推论</h1>

<p>产品停用ES时：</p>

<p><img class="shadow" src="/img/in-post/disable_es1.png" width="1200" /></p>

<p>上图中，红色箭头1，是自己手动添加的，这个步骤，原先是放在红色箭头2的函数里的。 可以看出，停用ES服务时，先拔除了elasticsearch的开机自启动，再进行ES disk分区的擦写操作（其中包括修改/etc/fstab文件）：</p>

<p><img class="shadow" src="/img/in-post/disable_es2.png" width="1200" /></p>

<p><img class="shadow" src="/img/in-post/disable_es3.png" width="1200" /></p>

<p>而ES disk对应的mount挂载点：</p>

<p><img class="shadow" src="/img/in-post/fstab_content.png" width="1200" /></p>

<p>options 选项是auto,部分journalctl -xb信息如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Jun 19 18:30:02 node76 kernel: ata2.00: Enabling discard_zeroes_data
Jun 19 18:30:02 node76 kernel:  sdf: sdf1
Jun 19 18:30:02 node76 kernel: ata2.00: Enabling discard_zeroes_data
Jun 19 18:30:02 node76 kernel:  sdf:
Jun 19 18:30:02 node76 multipath[854423]: sdf: using deprecated getuid callout
Jun 19 18:30:02 node76 systemd-udevd[854418]: inotify_add_watch(9, /dev/sdf1, 10) failed: No such file or directory
Jun 19 18:30:02 node76 systemd[1]: Mounting /opt/datasearch/0...
-- Subject: Unit opt-datasearch-0.mount has begun start-up
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
-- Unit opt-datasearch-0.mount has begun starting up.
Jun 19 18:30:02 node76 systemd[1]: Stopped target Local File Systems.
-- Subject: Unit local-fs.target has finished shutting down
cal-fs.targetlocal-fs.target
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
</code></pre></div></div>

<p>推断，local-fs.target requires <code class="highlighter-rouge">opt-datasearch-0.mount</code>，而对应挂载点出现’not found’(见开篇’systemctl –failed’的输出信息)，导致local-fs.target出现timeout（DefaultTimeoutStartSec=90，/etc/systemd/system.conf文件中，默认90s），而local-fs.target.wants是需要/etc/fstab,这里还有个Conflicts=shutdown.target</p>

<p><img class="shadow" src="/img/in-post/local-fs.target.wants.png" width="1200" /></p>

<p>最终应该是触发了shutdown操作，停止了众多的服务，而被停止的服务，是依赖于local-fs.target的，以ceph-osd为示例：</p>

<p><img class="shadow" src="/img/in-post/ceph-osd.target.wants.png" width="1200" /></p>

<h1 id="结语">结语</h1>

<p>分析至此，基本上知道问题的所在了，具体解法如下：</p>

<ul>
  <li>启用ES服务时，等ES相关的服务启用好后，最最后更改/etc/fstab文件；</li>
  <li>停用ES服务时，第一步就是更改/etc/fstab文件。</li>
</ul>

<h1 id="参考文档">参考文档</h1>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://zhangguanzhang.github.io/2019/01/30/fstab/
https://www.freedesktop.org/software/systemd/man/systemd.mount.html
https://www.freedesktop.org/software/systemd/man/systemd-system.conf.html#
http://www.jinbuguo.com/systemd/systemd.special.html
https://unix.stackexchange.com/questions/416640/how-to-disable-systemd-agressive-emergency-shell-behaviour
https://www.freedesktop.org/software/systemd/man/systemd.unit.html
</code></pre></div></div>

