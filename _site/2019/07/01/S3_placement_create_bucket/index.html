<p>i—
layout:     post
title:      “S3 placement to create bucket”
subtitle:   “S3 placement to create bucket”
date:       2019-07-01
author:     “Gavin”
catalog:    true
tags:
    - python
—</p>

<p>s3_placement_create_bucket.py</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python
# -*- coding:UTF-8 -*-
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">boto</span>
<span class="kn">import</span> <span class="nn">boto.s3.connection</span>

<span class="kn">from</span> <span class="nn">ezs3.command</span> <span class="kn">import</span> <span class="n">do_cmd</span>


<span class="k">def</span> <span class="nf">connect_s3</span><span class="p">(</span><span class="n">access_key</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Connection to S3"</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">boto</span><span class="p">.</span><span class="n">connect_s3</span><span class="p">(</span>
           <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">access_key</span><span class="p">,</span>
           <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">secret_key</span><span class="p">,</span>
           <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
           <span class="n">calling_format</span> <span class="o">=</span> <span class="n">boto</span><span class="p">.</span><span class="n">s3</span><span class="p">.</span><span class="n">connection</span><span class="p">.</span><span class="n">OrdinaryCallingFormat</span><span class="p">(),</span>
          <span class="p">)</span>

    <span class="k">return</span> <span class="n">conn</span>


<span class="k">def</span> <span class="nf">check_s3_placement</span><span class="p">(</span><span class="n">s3_placement</span><span class="p">):</span>
    <span class="n">s3_placement_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">do_cmd</span><span class="p">(</span><span class="s">"radosgw-admin zone get --rgw-zone=default"</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">each_key</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s">'placement_pools'</span><span class="p">]:</span>
        <span class="n">s3_placement_set</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">each_key</span><span class="p">[</span><span class="s">'key'</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">s3_placement</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s3_placement_set</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[ERROR]  Not exist this S3 placement, please create it first."</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_bucket</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">s3_placement</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Start to create bucket :({}) in S3 placement : ({})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">s3_placement</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s">':{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">s3_placement</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bucket</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">access_key</span> <span class="o">=</span><span class="s">'7T0GOCXVGOJXFI4IQJH2'</span>
    <span class="n">secret_key</span> <span class="o">=</span> <span class="s">'uLqJD5hrkMqtgg0lNQWTWLGod7415L0mB5BIxZEX'</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s">'172.17.75.97'</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="s">'seg_bucket_test'</span>
    <span class="n">s3_placement</span> <span class="o">=</span> <span class="s">'new_s3_placement'</span>


    <span class="n">conn</span> <span class="o">=</span> <span class="n">connect_s3</span><span class="p">(</span><span class="n">access_key</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
    <span class="n">check_s3_placement</span><span class="p">(</span><span class="n">s3_placement</span><span class="p">)</span>
    <span class="n">create_bucket</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">s3_placement</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div>
